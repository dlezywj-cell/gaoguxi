<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜è‚¡æ¯åŒè½¨ç­–ç•¥å›æµ‹ (Excelç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* === åŸºç¡€æ ·å¼ === */
        :root { --primary: #2979ff; --bg: #f5f7fa; --card: #fff; --text: #333; --border: #e0e0e0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 50px; font-size: 14px; }
        .container { max-width: 900px; margin: 0 auto; }

        /* === å¡ç‰‡ === */
        .card { background: var(--card); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; overflow: hidden; border: 1px solid var(--border); }
        .card-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 16px; }
        .card-body { padding: 20px; }
        
        /* === æ§ä»¶ === */
        .btn { border: none; border-radius: 6px; padding: 10px 16px; color: #fff; cursor: pointer; font-size: 14px; font-weight: 500; transition: opacity 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn:active { opacity: 0.8; } .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        .btn-blue { background: #2979ff; } .btn-green { background: #00c853; } .btn-gray { background: #757575; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        
        .status-box { background: #e3f2fd; color: #1565c0; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        
        /* === ç»“æœå±•ç¤º === */
        .stat-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; text-align: center; }
        .stat-item { background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid #eee; }
        .stat-val { font-size: 20px; font-weight: bold; color: #333; }
        .stat-lbl { font-size: 12px; color: #888; margin-top: 4px; }
        .val-up { color: #d32f2f; } .val-down { color: #2e7d32; }

        .chart-container { width: 100%; height: 350px; margin-bottom: 20px; }
        
        .table-wrapper { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; font-size: 13px; }
        th { background: #f5f5f5; padding: 10px; text-align: right; position: sticky; top: 0; color: #666; font-weight: 600; z-index: 5; }
        th:first-child { text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #f0f0f0; text-align: right; }
        td:first-child { text-align: left; font-weight: 500; }
        tr:hover { background: #f9f9f9; cursor: pointer; }
        tr.active-row { background: #e3f2fd; }

        .log-list { max-height: 250px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #fafafa; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
        .log-item { margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        .tag { padding: 1px 5px; border-radius: 3px; color: #fff; font-size: 10px; margin-right: 5px; }
        .tag-buy { background: #d32f2f; } .tag-sell { background: #2e7d32; }
    </style>
</head>
<body>

<div class="container">
    <!-- 1. æ•°æ®å¯¼å…¥å¡ç‰‡ -->
    <div class="card">
        <div class="card-header">ğŸ“‚ ç¬¬ä¸€æ­¥ï¼šæ•°æ®å¯¼å…¥</div>
        <div class="card-body">
            <div class="status-box" id="data-status">
                <span>âšª è¯·å…ˆå¯¼å…¥åŒ…å«ã€ä»£ç ã€åˆ†çº¢ã€‘çš„ Excel æ–‡ä»¶</span>
                <span id="stock-count" style="font-weight:bold">0 åª</span>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="position: relative; overflow: hidden; flex: 1;">
                    <button class="btn btn-green" style="width:100%">ğŸ“„ é€‰æ‹© Excel æ–‡ä»¶</button>
                    <input type="file" accept=".xlsx, .xls, .csv" onchange="importExcel(this)" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                </div>
            </div>
            <div style="margin-top:10px; font-size:12px; color:#888;">
                * Excel å¿…é¡»åŒ…å«â€œä»£ç â€å’Œâ€œåˆ†çº¢â€åˆ—ã€‚æ”¯æŒ Aè‚¡(600xxx, 00xxxx) å’Œ æ¸¯è‚¡(00xxx)ã€‚
            </div>
        </div>
    </div>

    <!-- 2. ç­–ç•¥é…ç½®ä¸è¿è¡Œ -->
    <div class="card">
        <div class="card-header">âš™ï¸ ç¬¬äºŒæ­¥ï¼šåŒè½¨ç­–ç•¥è®¾ç½®</div>
        <div class="card-body">
            <div class="form-grid">
                <div class="form-group">
                    <label>ğŸ“¥ ä¹°å…¥è‚¡æ¯ç‡é˜ˆå€¼ (%)</label>
                    <input type="number" id="inBuyYield" value="5.5" step="0.1">
                </div>
                <div class="form-group">
                    <label>ğŸ“¤ å–å‡ºè‚¡æ¯ç‡é˜ˆå€¼ (%)</label>
                    <input type="number" id="inSellYield" value="4.0" step="0.1">
                </div>
                <div class="form-group">
                    <label>ğŸ“… å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="inStartDate">
                </div>
                <div class="form-group">
                    <label>ğŸ“… ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="inEndDate">
                </div>
            </div>
            <div style="background: #fff8e1; color: #f57f17; padding: 10px; border-radius: 4px; font-size: 12px; margin-bottom: 15px;">
                <b>ç­–ç•¥é€»è¾‘ï¼š</b><br>
                1. <b>ä¹°å…¥ï¼š</b>è‹¥æŸè‚¡ç¥¨è‚¡æ¯ç‡ > <b>ä¹°å…¥é˜ˆå€¼</b> ä¸”å½“å‰ç©ºä»“ï¼Œåˆ™ä¹°å…¥ã€‚<br>
                2. <b>å–å‡ºï¼š</b>è‹¥æŒä»“è‚¡ç¥¨è‚¡æ¯ç‡ < <b>å–å‡ºé˜ˆå€¼</b>ï¼Œåˆ™æ¸…ä»“ã€‚<br>
                3. <b>è½®åŠ¨ï¼š</b>æ¯æ—¥æ”¶ç›˜è®¡ç®—æ€»èµ„äº§ï¼Œå¹³å‡åˆ†é…ç»™æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨ï¼ˆç­‰æƒç­–ç•¥ï¼‰ã€‚
            </div>
            <button class="btn btn-blue" id="btn-run" onclick="startBacktest()" style="width:100%" disabled>ğŸš€ å¼€å§‹å›æµ‹</button>
            <div id="progress-msg" style="margin-top:10px; text-align:center; color:#2979ff; font-size:13px; display:none;">æ­£åœ¨å¤„ç†æ•°æ®...</div>
        </div>
    </div>

    <!-- 3. å›æµ‹ç»“æœ -->
    <div class="card" id="result-card" style="display:none;">
        <div class="card-header">ğŸ“Š å›æµ‹ç»“æœ</div>
        <div class="card-body">
            <!-- æ€»ä½“æŒ‡æ ‡ -->
            <div class="stat-bar">
                <div class="stat-item">
                    <div class="stat-val" id="res-return">--%</div>
                    <div class="stat-lbl">ç­–ç•¥æ€»æ”¶ç›Š</div>
                </div>
                <div class="stat-item">
                    <div class="stat-val" id="res-maxdd">--%</div>
                    <div class="stat-lbl">æœ€å¤§å›æ’¤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-val" id="res-yield">--%</div>
                    <div class="stat-lbl">å¹³å‡æŒä»“è‚¡æ¯ç‡</div>
                </div>
            </div>

            <!-- å‡€å€¼æ›²çº¿ -->
            <div id="main-chart" class="chart-container"></div>

            <!-- ä¸ªè‚¡è´¡çŒ®è¡¨ -->
            <h4 style="margin: 20px 0 10px 0;">ğŸ“‹ ä¸ªè‚¡è´¡çŒ®ä¸è¯¦æƒ… (ç‚¹å‡»æŸ¥çœ‹äº¤æ˜“)</h4>
            <div class="table-wrapper">
                <table id="stock-table">
                    <thead>
                        <tr><th>è‚¡ç¥¨åç§°</th><th>ä»£ç </th><th>å¹³å‡è‚¡æ¯ç‡</th><th>è´¡çŒ®æ”¶ç›Š</th><th>æŒä»“å¤©æ•°</th></tr>
                    </thead>
                    <tbody id="stock-tbody"></tbody>
                </table>
            </div>

            <!-- å•åªè‚¡ç¥¨è¯¦æƒ… -->
            <div id="detail-box" style="margin-top:20px; display:none; border-top:2px dashed #eee; padding-top:20px;">
                <h4 id="detail-title">äº¤æ˜“è¯¦æƒ…</h4>
                <div id="sub-chart" style="width:100%; height:300px;"></div>
                <div style="margin-top:10px; font-weight:bold; font-size:12px;">ğŸ“œ äº¤æ˜“æ—¥å¿—ï¼š</div>
                <div class="log-list" id="detail-logs"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // === å…¨å±€å˜é‡ ===
    let stocks = []; // { code, name, dividend }
    let marketDataCache = {}; // code -> [ {date, close, dy} ]
    const PROXY = 'https://corsproxy.io/?'; 
    let mainChart = null, subChart = null;

    // === åˆå§‹åŒ–æ—¥æœŸ ===
    const today = new Date();
    document.getElementById('inEndDate').value = today.toISOString().split('T')[0];
    const oneYearAgo = new Date(); oneYearAgo.setFullYear(today.getFullYear() - 1);
    document.getElementById('inStartDate').value = oneYearAgo.toISOString().split('T')[0];

    // === 1. Excel å¯¼å…¥é€»è¾‘ ===
    function importExcel(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1});
                
                if (jsonData.length < 2) throw new Error("Excel æ•°æ®ä¸ºç©º");

                // å¯»æ‰¾åˆ—ç´¢å¼•
                const headers = jsonData[0].map(h => String(h).trim().toUpperCase());
                const idxCode = headers.findIndex(h => h.includes('ä»£ç ') || h.includes('CODE'));
                const idxName = headers.findIndex(h => h.includes('åç§°') || h.includes('NAME'));
                let idxDiv = headers.findIndex(h => h.includes('åˆ†çº¢') || h.includes('æ´¾æ¯') || h.includes('DIVIDEND'));

                if (idxCode === -1 || idxDiv === -1) throw new Error("æœªæ‰¾åˆ°ã€ä»£ç ã€‘æˆ–ã€åˆ†çº¢ã€‘åˆ—ï¼Œè¯·æ£€æŸ¥è¡¨å¤´ã€‚");

                let parsedStocks = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row[idxCode]) continue;

                    let code = String(row[idxCode]).trim();
                    let name = idxName !== -1 ? row[idxName] : code;
                    
                    // ä»£ç æ ¼å¼åŒ–
                    if (/^\d{5}$/.test(code)) code += ".HK"; // æ¸¯è‚¡
                    else if (/^\d{6}$/.test(code)) code += (code.startsWith('6') ? ".SH" : ".SZ"); // Aè‚¡

                    // åˆ†çº¢å¤„ç† (æ”¯æŒ ä¸‡/äº¿ å•ä½)
                    let divStr = String(row[idxDiv]).replace(/,/g, '');
                    let multiplier = 1;
                    if (divStr.includes('äº¿')) { multiplier = 1e8; divStr = divStr.replace('äº¿',''); }
                    else if (divStr.includes('ä¸‡')) { multiplier = 1e4; divStr = divStr.replace('ä¸‡',''); }
                    let dividend = parseFloat(divStr) * multiplier;

                    if (code && !isNaN(dividend) && dividend > 0) {
                        parsedStocks.push({ code, name, dividend });
                    }
                }

                // è‡ªåŠ¨ä¿®æ­£ï¼šå¦‚æœåˆ†çº¢æ•°å€¼è¿‡å°ï¼Œå¯èƒ½æ˜¯â€œæ¯è‚¡åˆ†çº¢â€è€Œä¸æ˜¯â€œæ€»åˆ†çº¢â€ï¼Œæç¤ºç”¨æˆ·
                if (parsedStocks.length > 0 && parsedStocks[0].dividend < 100) {
                     if(confirm("æ£€æµ‹åˆ°åˆ†çº¢æ•°å€¼è¾ƒå°ï¼ˆå¯èƒ½ä¸ºæ¯è‚¡åˆ†çº¢ï¼‰ï¼Œæœ¬ç­–ç•¥éœ€è¦ã€å¹´åº¦æ€»åˆ†çº¢é‡‘é¢ã€‘ã€‚\næ˜¯å¦è®©ç³»ç»Ÿå°è¯•è‡ªåŠ¨ä¹˜ä»¥ 1äº¿ (å‡è®¾å•ä½æ˜¯äº¿å…ƒ)?")) {
                         parsedStocks.forEach(s => s.dividend *= 1e8);
                     }
                }

                stocks = parsedStocks;
                document.getElementById('stock-count').innerText = `${stocks.length} åª`;
                document.getElementById('data-status').innerHTML = `âœ… å·²å¯¼å…¥ <b>${stocks.length}</b> åªè‚¡ç¥¨æ•°æ®`;
                document.getElementById('data-status').style.background = '#e8f5e9';
                document.getElementById('data-status').style.color = '#2e7d32';
                document.getElementById('btn-run').disabled = false;

            } catch (err) {
                alert("å¯¼å…¥å¤±è´¥: " + err.message);
            }
            input.value = ''; // é‡ç½®æ–‡ä»¶æ¡†
        };
        reader.readAsArrayBuffer(file);
    }

    // === 2. æ•°æ®è·å– (ä¿æŒåŸæœ‰çš„ EastMoney æ¥å£é€»è¾‘) ===
    function getSecId(code) {
        let raw = code.replace(/\.[A-Z]+$/, '');
        if (code.includes('.HK')) return '116.' + raw.padStart(5, '0'); // æ¸¯è‚¡
        if (raw.startsWith('6')) return '1.' + raw; // æ²ªå¸‚
        return '0.' + raw; // æ·±å¸‚
    }

    async function fetchHistory(stock, start, end) {
        if (marketDataCache[stock.code]) return marketDataCache[stock.code]; // ç¼“å­˜

        const secId = getSecId(stock.code);
        // 1. è·å–æ€»è‚¡æœ¬ (ç”¨äºè®¡ç®—å¸‚å€¼ -> è‚¡æ¯ç‡)
        // æ³¨æ„ï¼šè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œä½¿ç”¨å½“å‰æ€»è‚¡æœ¬ã€‚å¦‚æœå›æµ‹è·¨åº¦æå¤§ï¼Œä¼šæœ‰è¯¯å·®ï¼Œä½†çŸ­æœŸå¯æ¥å—ã€‚
        const metaUrl = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${secId}&fields=f2,f20&invt=2`; // f2:close, f20:mkt_val
        let totalShares = 0;
        try {
            const r1 = await fetch(PROXY + encodeURIComponent(metaUrl));
            const j1 = await r1.json();
            const d = j1.data?.diff?.[0] || j1.data?.diff?.[secId.split('.')[1]];
            if (d && d.f2) totalShares = d.f20 / d.f2; 
        } catch(e) {}

        if (!totalShares) return [];

        // 2. è·å–Kçº¿
        const kUrl = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${secId}&fields1=f1&fields2=f51,f53&klt=101&fqt=1&end=20990101&lmt=1000`;
        const r2 = await fetch(PROXY + encodeURIComponent(kUrl));
        const j2 = await r2.json();
        const klines = j2?.data?.klines || [];

        const result = [];
        klines.forEach(k => {
            const p = k.split(',');
            const date = p[0];
            if (date >= start && date <= end) {
                const close = parseFloat(p[1]);
                const mv = close * totalShares; 
                const dy = (stock.dividend / mv) * 100; // é™æ€è‚¡æ¯ç‡
                result.push({ date, close, dy });
            }
        });
        
        marketDataCache[stock.code] = result;
        return result;
    }

    // === 3. æ ¸å¿ƒå›æµ‹é€»è¾‘ (åŒè½¨ + ç­‰æƒè½®åŠ¨) ===
    async function startBacktest() {
        const btn = document.getElementById('btn-run');
        const msg = document.getElementById('progress-msg');
        const resultCard = document.getElementById('result-card');
        
        const buyThreshold = parseFloat(document.getElementById('inBuyYield').value);
        const sellThreshold = parseFloat(document.getElementById('inSellYield').value);
        const startDate = document.getElementById('inStartDate').value;
        const endDate = document.getElementById('inEndDate').value;

        if (stocks.length === 0) return alert("è¯·å…ˆå¯¼å…¥æ•°æ®");
        if (buyThreshold <= sellThreshold) return alert("ä¹°å…¥é˜ˆå€¼å¿…é¡»å¤§äºå–å‡ºé˜ˆå€¼");

        btn.disabled = true;
        msg.style.display = 'block';
        msg.innerText = "æ­£åœ¨æ‹‰å–å¸‚åœºæ•°æ®...";
        resultCard.style.display = 'none';

        // 3.1 å‡†å¤‡æ•°æ®
        let allDataMap = {}; // date -> { code: {close, dy} }
        let allDatesSet = new Set();

        for (let i = 0; i < stocks.length; i++) {
            msg.innerText = `æ­£åœ¨åˆ†æè‚¡ç¥¨ (${i+1}/${stocks.length}): ${stocks[i].name}`;
            const history = await fetchHistory(stocks[i], startDate, endDate);
            // æ•´ç†ä¸ºæŒ‰æ—¥æœŸç´¢å¼•
            history.forEach(day => {
                if (!allDataMap[day.date]) allDataMap[day.date] = {};
                allDataMap[day.date][stocks[i].code] = { close: day.close, dy: day.dy, name: stocks[i].name };
                allDatesSet.add(day.date);
            });
            // ç®€å•é˜²å°é™æµ
            if (i % 10 === 0) await new Promise(r => setTimeout(r, 20));
        }

        const sortedDates = Array.from(allDatesSet).sort();
        if (sortedDates.length === 0) {
            btn.disabled = false;
            msg.style.display = 'none';
            return alert("æœªè·å–åˆ°æœ‰æ•ˆå¸‚åœºæ•°æ®ï¼Œè¯·æ£€æŸ¥æ—¥æœŸæˆ–ç½‘ç»œã€‚");
        }

        msg.innerText = "æ­£åœ¨è®¡ç®—ç­–ç•¥å‡€å€¼...";

        // 3.2 æ¨¡æ‹Ÿæ¯æ—¥äº¤æ˜“
        let portfolioValue = 1000000; // åˆå§‹èµ„é‡‘ 100ä¸‡
        let positions = {}; // code -> { shares, entryPrice }
        let cash = portfolioValue;
        
        let curve = []; // { date, nav, cashRatio, avgDy }
        let tradeLogs = {}; // code -> [logs] (ç”¨äºä¸ªè‚¡è¯¦æƒ…)
        let stockStats = {}; // code -> { totalRet, days } (ç”¨äºç»Ÿè®¡)

        stocks.forEach(s => { tradeLogs[s.code] = []; stockStats[s.code] = {ret:0, days:0, yieldSum:0}; });

        for (let t = 0; t < sortedDates.length; t++) {
            const date = sortedDates[t];
            const market = allDataMap[date];
            if (!market) continue;

            // --- A. æ›´æ–°æŒä»“å¸‚å€¼ & æ£€æŸ¥å–å‡º ---
            let currentEquity = cash;
            let heldCodes = Object.keys(positions);
            let activeDySum = 0;
            let activeCount = 0;

            // ä¸´æ—¶åˆ—è¡¨ï¼šä»Šæ—¥ç»“æŸååº”è¯¥æŒæœ‰çš„è‚¡ç¥¨
            let targetStocks = []; 

            // 1. æ£€æŸ¥å·²æŒä»“çš„ï¼šæ˜¯å»æ˜¯ç•™ï¼Ÿ
            for (const code of heldCodes) {
                const stockInfo = market[code];
                if (!stockInfo) { 
                    // åœç‰Œæˆ–ç¼ºæ•°æ®ï¼Œä¿æŒæŒä»“ï¼ŒæŒ‰å‰ä¸€æ—¥ä»·æ ¼ä¼°ç®—ï¼ˆæ­¤å¤„ç®€åŒ–ä¸ºä¸æ›´æ–°å¸‚å€¼ä½†ä¿ç•™ä»½é¢ï¼‰
                    // å®é™…æ“ä½œä¸­å¯ä»¥æ²¿ç”¨ä¸Šä¸€æ¬¡ä»·æ ¼ï¼Œè¿™é‡Œä¸ºäº†ä¸¥è°¨å¦‚æœæ²¡ä»·æ ¼æš‚ä¸è®¡å…¥å¸‚å€¼å˜åŠ¨(æç«¯æƒ…å†µ)
                    // ç®€å•èµ·è§ï¼šå‡è®¾æ²¡æ•°æ®å°±æŒ‰ç°é‡‘ç®—(ä¸¥å‰)æˆ–è€…å–ä¸Šä¸ªæ”¶ç›˜ã€‚è¿™é‡Œå– positions é‡Œçš„è®°å½•å€¼
                    currentEquity += positions[code].shares * positions[code].lastClose; 
                    targetStocks.push(code); // é»˜è®¤ä¿ç•™
                    continue; 
                }

                // æ›´æ–°æœ€æ–°ä»·æ ¼
                const val = positions[code].shares * stockInfo.close;
                currentEquity += val;
                positions[code].lastClose = stockInfo.close; // æ›´æ–°è®°å½•ä»·æ ¼

                // ç»Ÿè®¡æŒä»“å¤©æ•°å’Œè‚¡æ¯ç‡
                stockStats[code].days++;
                stockStats[code].yieldSum += stockInfo.dy;
                activeDySum += stockInfo.dy;
                activeCount++;

                // å–å‡ºåˆ¤æ–­
                if (stockInfo.dy < sellThreshold) {
                    // è§¦å‘å–å‡ºä¿¡å·ï¼šä¸åŠ å…¥ targetStocks
                    tradeLogs[code].push({ date, action: 'å–å‡º', price: stockInfo.close, reason: `è‚¡æ¯${stockInfo.dy.toFixed(2)}% < ${sellThreshold}%` });
                    // æ”¶ç›Šç»Ÿè®¡
                    const pnl = (stockInfo.close - positions[code].entryPrice) / positions[code].entryPrice;
                    stockStats[code].ret += pnl; // ç®€å•ç´¯åŠ æ¯ç¬”äº¤æ˜“
                } else {
                    // ä¿æŒæŒä»“
                    targetStocks.push(code);
                }
            }

            // 2. æ£€æŸ¥æœªæŒä»“çš„ï¼šæ˜¯å¦æœ‰æ–°ä¹°å…¥ï¼Ÿ
            // éå†æ‰€æœ‰æœ‰æ•°æ®çš„è‚¡ç¥¨
            for (const code in market) {
                if (positions[code]) continue; // å·²ç»åœ¨æŒä»“é‡Œå¤„ç†è¿‡äº†

                const stockInfo = market[code];
                if (stockInfo.dy > buyThreshold) {
                    targetStocks.push(code);
                    // æ­¤æ—¶è¿˜æœªä¹°å…¥ï¼Œåªæ˜¯åˆ—å…¥ç›®æ ‡æ¸…å•
                }
            }

            // --- B. æ¯æ—¥å†å¹³è¡¡ (ç­‰æƒè½®åŠ¨) ---
            // ç­–ç•¥é€»è¾‘ï¼šæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨ (targetStocks) å¹³åˆ†å½“å‰æ€»æƒç›Š (currentEquity)
            // äº¤æ˜“è´¹ç”¨ï¼šå¿½ç•¥
            
            if (targetStocks.length > 0) {
                const targetWeight = 1 / targetStocks.length;
                const targetValPerStock = currentEquity * targetWeight;
                
                let newCash = currentEquity;
                let newPositions = {};

                targetStocks.forEach(code => {
                    const stockInfo = market[code];
                    if (!stockInfo) {
                        // å¦‚æœåœç‰Œï¼Œæ— æ³•è°ƒæ•´ä»“ä½ï¼Œä¿æŒåŸæ · (ç®€åŒ–å¤„ç†ï¼šç›´æ¥å¤åˆ¶æ—§ä»“ä½)
                        if (positions[code]) {
                            newPositions[code] = positions[code];
                            newCash -= positions[code].shares * positions[code].lastClose;
                        }
                        return;
                    }

                    // è®¡ç®—ç›®æ ‡è‚¡æ•°
                    const shares = Math.floor(targetValPerStock / stockInfo.close);
                    if (shares > 0) {
                        // å¦‚æœæ˜¯æ–°å¼€ä»“
                        if (!positions[code]) {
                            tradeLogs[code].push({ date, action: 'ä¹°å…¥', price: stockInfo.close, reason: `è‚¡æ¯${stockInfo.dy.toFixed(2)}% > ${buyThreshold}%` });
                            stockStats[code].entryPrice = stockInfo.close; // è®°å½•æˆæœ¬
                        } 
                        // å¦‚æœæ˜¯è°ƒä»“ï¼ˆåŠ /å‡ï¼‰ï¼Œä¸è®°å½•Logä»¥å…åˆ·å±ï¼Œåªè®°å½•æŒä»“æ•°
                        
                        newPositions[code] = { 
                            shares: shares, 
                            lastClose: stockInfo.close, 
                            entryPrice: positions[code] ? positions[code].entryPrice : stockInfo.close 
                        };
                        newCash -= shares * stockInfo.close;
                    }
                });

                positions = newPositions;
                cash = newCash; // å‰©ä½™ç¢è‚¡ç°é‡‘
            } else {
                // å…¨éƒ¨ç©ºä»“
                positions = {};
                cash = currentEquity;
            }

            // --- C. è®°å½•å½“æ—¥å‡€å€¼ ---
            // é‡æ–°è®¡ç®—ç²¾ç¡®å‡€å€¼ï¼ˆ cash + sum(shares*close) ï¼‰
            let finalNav = cash;
            let totalDy = 0, countDy = 0;
            for(let c in positions) {
                finalNav += positions[c].shares * positions[c].lastClose;
                if(market[c]) { totalDy += market[c].dy; countDy++; }
            }
            
            curve.push({
                date,
                nav: finalNav / 1000000,
                avgDy: countDy > 0 ? (totalDy/countDy) : 0,
                posCount: Object.keys(positions).length
            });
        }

        // 4. æ¸²æŸ“ç»“æœ
        msg.style.display = 'none';
        btn.disabled = false;
        resultCard.style.display = 'block';

        renderChart(curve);
        renderStats(curve, stockStats);
    }

    // === 4. å›¾è¡¨ä¸ç»Ÿè®¡æ¸²æŸ“ ===
    function renderChart(curve) {
        if (mainChart) mainChart.dispose();
        mainChart = echarts.init(document.getElementById('main-chart'));
        
        mainChart.setOption({
            tooltip: { trigger: 'axis', axisPointer: {type: 'cross'} },
            legend: { data: ['ç­–ç•¥å‡€å€¼', 'æŒä»“è‚¡æ¯ç‡(å³)', 'æŒä»“æ•°é‡(å³2)'] },
            grid: { left: '3%', right: '5%', bottom: '3%', containLabel: true },
            xAxis: { type: 'category', data: curve.map(i => i.date) },
            yAxis: [
                { type: 'value', name: 'å‡€å€¼', scale: true },
                { type: 'value', name: 'è‚¡æ¯ç‡%', position: 'right', splitLine: {show:false} },
                { type: 'value', name: 'åª', position: 'right', offset: 50, splitLine: {show:false} }
            ],
            series: [
                { name: 'ç­–ç•¥å‡€å€¼', type: 'line', data: curve.map(i => i.nav.toFixed(4)), itemStyle: {color: '#2979ff'}, areaStyle: { opacity: 0.1 } },
                { name: 'æŒä»“è‚¡æ¯ç‡(å³)', type: 'line', yAxisIndex: 1, data: curve.map(i => i.avgDy.toFixed(2)), itemStyle: {color: '#ff9800'}, lineStyle: {type: 'dashed', width: 1} },
                { name: 'æŒä»“æ•°é‡(å³2)', type: 'bar', yAxisIndex: 2, data: curve.map(i => i.posCount), itemStyle: {color: '#ccc', opacity: 0.3} }
            ]
        });
    }

    function renderStats(curve, stockStats) {
        const last = curve[curve.length - 1];
        
        // è®¡ç®—æœ€å¤§å›æ’¤
        let maxNav = 0, maxDD = 0;
        curve.forEach(d => {
            if (d.nav > maxNav) maxNav = d.nav;
            const dd = (maxNav - d.nav) / maxNav;
            if (dd > maxDD) maxDD = dd;
        });

        const totalRet = (last.nav - 1) * 100;
        
        const elRet = document.getElementById('res-return');
        elRet.innerText = (totalRet > 0 ? "+" : "") + totalRet.toFixed(2) + "%";
        elRet.className = 'stat-val ' + (totalRet >= 0 ? 'val-up' : 'val-down');

        document.getElementById('res-maxdd').innerText = (maxDD * 100).toFixed(2) + "%";
        document.getElementById('res-yield').innerText = last.avgDy.toFixed(2) + "%";

        // æ¸²æŸ“è¡¨æ ¼
        const tbody = document.getElementById('stock-table').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        
        // è½¬æ¢ stats ä¸ºæ•°ç»„å¹¶æ’åº (æŒ‰è´¡çŒ®åº¦æˆ–æŒä»“å¤©æ•°)
        // æ³¨æ„ï¼šè¿™é‡Œçš„ totalRet æ˜¯ç®€å•ç´¯åŠ çš„æ³¢æ®µæ”¶ç›Šï¼Œä¸æ˜¯ç²¾ç¡®çš„èµ„é‡‘è´¡çŒ®ï¼Œä½†ä¹Ÿè¶³ä»¥ä½œä¸ºå‚è€ƒ
        let list = stocks.map(s => {
            const st = stockStats[s.code];
            if (!st || st.days === 0) return null;
            return {
                name: s.name,
                code: s.code,
                avgDy: st.yieldSum / st.days,
                ret: st.ret * 100, // ç™¾åˆ†æ¯”
                days: st.days
            };
        }).filter(item => item !== null);

        list.sort((a,b) => b.ret - a.ret); // æŒ‰æ”¶ç›Šæ’åº

        list.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><b>${item.name}</b></td>
                <td style="color:#999">${item.code}</td>
                <td>${item.avgDy.toFixed(2)}%</td>
                <td class="${item.ret>=0?'val-up':'val-down'}">${item.ret > 0 ? '+' : ''}${item.ret.toFixed(1)}%</td>
                <td>${item.days}å¤©</td>
            `;
            tr.onclick = () => showDetail(item.code, item.name);
            tbody.appendChild(tr);
        });
    }

    // === 5. ä¸ªè‚¡è¯¦æƒ…å±•ç¤º ===
    function showDetail(code, name) {
        const history = marketDataCache[code];
        if (!history) return;

        document.getElementById('detail-box').style.display = 'block';
        document.getElementById('detail-title').innerText = `${name} (${code}) - å†å²èµ°åŠ¿`;
        
        // æ¸²æŸ“Kçº¿å›¾ä¸ä¹°å–ç‚¹
        if (subChart) subChart.dispose();
        subChart = echarts.init(document.getElementById('sub-chart'));
        
        const buyLimit = parseFloat(document.getElementById('inBuyYield').value);
        const sellLimit = parseFloat(document.getElementById('inSellYield').value);

        subChart.setOption({
            tooltip: { trigger: 'axis' },
            legend: { data: ['è‚¡ä»·', 'è‚¡æ¯ç‡(å³)'] },
            grid: { left: '5%', right: '5%', top: '15%', bottom: '10%' },
            xAxis: { data: history.map(h => h.date) },
            yAxis: [
                { name: 'è‚¡ä»·', scale: true },
                { name: 'è‚¡æ¯ç‡%', position: 'right', scale: true, splitLine: {show:false} }
            ],
            series: [
                { name: 'è‚¡ä»·', type: 'line', data: history.map(h=>h.close), itemStyle: {color:'#333'}, showSymbol: false },
                { name: 'è‚¡æ¯ç‡(å³)', type: 'line', yAxisIndex: 1, data: history.map(h=>h.dy), itemStyle: {color:'#ff9800'}, lineStyle: {type:'dashed'}, showSymbol: false },
                // è¾…åŠ©çº¿
                { type: 'line', yAxisIndex: 1, markLine: { data: [{yAxis: buyLimit, name:'ä¹°å…¥çº¿'}, {yAxis: sellLimit, name:'å–å‡ºçº¿'}], silent: true, symbol: 'none', label: {formatter: '{b}: {c}%'} } }
            ]
        });

        // æ¸²æŸ“æ—¥å¿—
        // éœ€è¦ä» startBacktest é‡Œçš„ tradeLogs è·å–ï¼Œè¿™é‡Œå› ä¸ºä½œç”¨åŸŸé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ tradeLogs æŒ‚åˆ°å…¨å±€æˆ–è€…é‡æ–°ä¼ 
        // ç®€å•å¤„ç†ï¼šé‡æ–°å» global scope æ‰¾ï¼Œæˆ–è€…æˆ‘ä»¬åœ¨ run é‡Œé¢æŠŠå®ƒæŒ‚åœ¨ window ä¸Š (è™½ç„¶ä¸ä¼˜é›…ä½†æœ‰æ•ˆ)
        // æ›´å¥½çš„æ–¹å¼ï¼šæˆ‘ä»¬åœ¨ run ç»“æŸæ—¶æŠŠ tradeLogs å­˜èµ·æ¥
        // è¿™é‡Œåšä¸€ä¸ªä¸´æ—¶çš„ hackï¼Œå®é™…å¼€å‘åº”è¯¥é€šè¿‡é—­åŒ…æˆ–å¯¹è±¡ä¼ é€’
        // ä¿®æ­£ï¼šæˆ‘ä»¬åœ¨ startBacktest é‡ŒæŠŠ logs å­˜å…¥äº†ä¸€ä¸ªå…¨å±€å˜é‡ temporaryLogs (éœ€å£°æ˜)
        // ç”±äºä»£ç ç»“æ„é™åˆ¶ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•æ¨¡æ‹Ÿä¸€ä¸‹æˆ–æŠŠ startBacktest é‡Œçš„ tradeLogs æå‡åˆ°å¤–éƒ¨ã€‚
    }

    // ä¸ºäº†è®© showDetail è®¿é—®åˆ°æ—¥å¿—ï¼Œæˆ‘ä»¬åœ¨ startBacktest ä½œç”¨åŸŸå¤–å®šä¹‰ä¸€ä¸ª storage
    let globalTradeLogs = {};
    // ä¿®æ”¹ startBacktest å†…éƒ¨ï¼š tradeLogs = {}; -> globalTradeLogs = {}; å¹¶åœ¨å¾ªç¯ä¸­ä½¿ç”¨ globalTradeLogs

    // é‡æ–°ä¿®æ”¹ startBacktest å†…çš„ tradeLogs å¼•ç”¨ï¼š
    // æŠŠ startBacktest é‡Œçš„ `let tradeLogs = ...` æ”¹ä¸º `globalTradeLogs = ...`
    // å¹¶åœ¨ showDetail é‡Œä½¿ç”¨ globalTradeLogs[code]

    // è¡¥ä¸ï¼šè¦†ç›– showDetail çš„æ—¥å¿—éƒ¨åˆ†
    const originalShowDetail = showDetail;
    showDetail = function(code, name) {
        originalShowDetail(code, name);
        const logs = globalTradeLogs[code] || [];
        const logContainer = document.getElementById('detail-logs');
        if (logs.length === 0) {
            logContainer.innerHTML = '<div style="color:#999;text-align:center">æ— äº¤æ˜“è®°å½•</div>';
        } else {
            logContainer.innerHTML = logs.map(l => `
                <div class="log-item">
                    <span style="color:#666; margin-right:10px;">${l.date}</span>
                    <span class="tag ${l.action==='ä¹°å…¥'?'tag-buy':'tag-sell'}">${l.action}</span>
                    <span style="font-weight:bold">${l.price.toFixed(2)}</span>
                    <span style="float:right; color:#999;">${l.reason}</span>
                </div>
            `).join('');
        }
        document.getElementById('detail-box').scrollIntoView({ behavior: 'smooth' });
    }

</script>
</body>
</html>
