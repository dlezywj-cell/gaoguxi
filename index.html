<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜è‚¡æ¯æ’è¡Œè½®åŠ¨ç­–ç•¥ (Top N%)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* === åŸºç¡€å˜é‡ === */
        :root { --primary: #007bff; --bg: #f4f6f9; --card: #fff; --text: #333; --border: #eee; --selected: #e3f2fd; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 80px; font-size: 14px; }
        .container { max-width: 800px; margin: 0 auto; }

        /* === å¡ç‰‡æ¡†æ¶ === */
        .card { background: var(--card); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; overflow: hidden; transition: all 0.3s; }
        .card-header { padding: 12px 15px; background: #fff; border-bottom: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 15px; user-select: none; cursor: pointer;}
        .header-title { flex: 1; display: flex; align-items: center; gap: 5px; }
        .card-body { display: none; padding: 15px; }
        .card.open .card-body { display: block; }
        .card.open .card-header { border-bottom-color: var(--border); }
        .arrow { font-size: 12px; color: #999; transition: transform 0.3s; }
        .card.open .arrow { transform: rotate(180deg); }

        /* === è¡¨å•ä¸æŒ‰é’® === */
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .form-group { flex: 1; min-width: 0; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-size:13px; background:#fff;}
        .run-bar { display: flex; gap: 10px; align-items: flex-end; background:#f8f9fa; padding:10px; border-radius:6px; margin-top:0; }
        
        #adv-settings { background: #fff; border: 1px dashed #ddd; padding: 10px; border-radius: 6px; margin-top: 5px; display: none; }
        .toggle-link { display: block; text-align: right; margin-top: 5px; margin-bottom: 5px; color: #007bff; font-size: 12px; cursor: pointer; user-select: none; }

        .btn { border: none; border-radius: 6px; padding: 10px; color: #fff; cursor: pointer; font-weight: 500; display:flex; align-items:center; justify-content:center; }
        .btn:active { opacity: 0.8; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        .btn-blue { background: #007bff; } .btn-green { background: #28a745; } .btn-purple { background: #6f42c1; } .btn-orange { background: #fd7e14; }
        .btn-orange.unsaved { background-color: #dc3545 !important; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        .btn-icon-square { width: 28px; height: 28px; padding: 0; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .btn-edit-yellow { background: #ffca28; color: #333; } .btn-del-red { background: #ef5350; color: #fff; }

        /* === è¡¨æ ¼ä¸ç»“æœ === */
        .summary-wrapper { overflow-x: auto; margin-bottom: 15px; border: 1px solid #eee; border-radius: 6px; max-height: 400px; }
        .summary-table { width: 100%; font-size: 13px; border-collapse: collapse; background: #fff; min-width: 300px; }
        .summary-table th { background: #f1f3f5; padding: 10px 8px; color: #555; font-weight: 600; text-align: right; position: sticky; top: 0; z-index: 10; }
        .summary-table th:first-child { text-align: left; }
        .summary-table td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: right; }
        .summary-table td:first-child { text-align: left; }
        .summary-table tr:hover { background: #f9f9f9; cursor: pointer; }
        .summary-table tr.selected { background: #e3f2fd !important; border-left: 3px solid #007bff; }
        .val-pos { color: #d32f2f; } .val-neg { color: #2e7d32; }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; margin-bottom: 15px; margin-top: 15px; }
        .stat-item { background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .stat-val { font-size: 16px; font-weight: bold; }
        .stat-lbl { font-size: 11px; color: #888; }
        .win { color: #d32f2f; } .loss { color: #2e7d32; }
        
        .base-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .base-table th { background: #f8f9fa; padding: 10px; text-align: left; font-size: 12px; color:#666; border-bottom: 1px solid #ddd; }
        .base-table td { padding: 12px 5px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; vertical-align: middle; }
        
        .log-table { width: 100%; min-width: 600px; border-collapse: collapse; }
        .log-table th { background: #fff; color: #666; font-size: 12px; position: sticky; top: 0; border-bottom: 2px solid #eee; text-align: left; padding: 8px 5px; z-index: 5; }
        .log-table td { padding: 8px 5px; border-bottom: 1px solid #f0f0f0; font-size: 12px; vertical-align: middle; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #fff; font-weight: normal; }
        .bg-red { background: #d32f2f; } .bg-green { background: #2e7d32; } .bg-gray { background: #999; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .modal-box { background: #fff; padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <!-- é…ç½®å¡ç‰‡ -->
    <div class="card open" id="card-config">
        <div class="card-header" onclick="toggleCard('card-config')">
            <div class="header-title"><span>âš™ï¸ ç­–ç•¥ä¸æ•°æ®</span></div><span class="arrow">â–¼</span>
        </div>
        <div class="card-body">
            <div style="background:#fff3cd; color:#856404; padding:10px; border-radius:6px; font-size:12px; margin-bottom:15px; border:1px solid #ffeeba;">
                <b>ğŸ’¡ æç¤ºï¼š</b> ç­–ç•¥ï¼š<b>æ’åè½®åŠ¨ (Top N%)</b>ã€‚<br>å°†ä»æ‰€æœ‰é€‰ä¸­çš„è‚¡ç¥¨ä¸­ï¼Œæ¯æœŸä¹°å…¥è‚¡æ¯ç‡æ’åé å‰çš„è‚¡ç¥¨ã€‚è¯·å¯¼å…¥åŒ…å«ã€ä»£ç ã€åˆ†çº¢ã€‘çš„ Excelã€‚
            </div>
            <div class="form-row">
                <div class="file-input-wrapper">
                    <button class="btn btn-green" style="width:100%">ğŸ“‚ 1. ä» Excel å¯¼å…¥è‚¡ç¥¨ä¸åˆ†çº¢æ•°æ®</button>
                    <input type="file" id="excel-file" accept=".xlsx, .xls, .csv" onchange="importFromExcel(this)">
                </div>
            </div>
            <div class="form-row" style="margin-top:10px;">
                <div class="form-group" style="flex:2"><label>è‚¡ç¥¨åç§°</label><input type="text" id="inName"></div>
                <div class="form-group" style="flex:1.5"><label>ä»£ç </label><input type="text" id="inCode"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>å¹´åº¦æ€»ç°é‡‘åˆ†çº¢(å…ƒ)</label><input type="number" id="inDividend"></div>
                <button class="btn btn-blue" id="btn-save-single" style="margin-bottom:1px;" onclick="saveStock()">â• ä¿®æ”¹/æ·»åŠ </button>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                <button class="btn btn-purple" style="flex:1" id="btn-pull" onclick="syncFromGithub()">â˜ï¸ æ‹‰å–é…ç½®</button>
                <button class="btn btn-orange" style="flex:1" id="btn-push" onclick="uploadToGithub()">ğŸš€ 2. ä¿å­˜é…ç½®åˆ° GitHub</button>
            </div>
        </div>
    </div>

    <!-- åˆ—è¡¨å¡ç‰‡ -->
    <div class="card open" id="card-list">
        <div class="card-header" onclick="toggleCard('card-list')">
            <div class="header-title"><span>ğŸ“‹ ç›‘æ§æ± </span><span id="list-count" style="font-weight:normal;margin-left:5px;color:#999;"></span></div><span class="arrow">â–¼</span>
        </div>
        <div class="card-body" style="padding:0">
            <div style="max-height: 350px; overflow-y: auto;">
                <table class="base-table">
                    <thead><tr><th>è‚¡ç¥¨ä¿¡æ¯</th><th>ç™»è®°åˆ†çº¢(å…ƒ)</th><th style="text-align:center;width:90px;">æ“ä½œ</th><th style="width:40px;text-align:center;"><input type="checkbox" id="check-all" onchange="toggleAllStocks(this)" checked></th></tr></thead>
                    <tbody id="stock-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ç»“æœå¡ç‰‡ -->
    <div class="card open" id="card-result">
        <div class="card-header" onclick="toggleCard('card-result')">
            <div class="header-title"><span>ğŸ“Š æ’è¡Œå›æµ‹ (Ranking)</span></div><span class="arrow">â–¼</span>
        </div>
        <div class="card-body">
            <div class="run-bar">
                <div class="form-group"><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="inStartDate"></div>
                <div class="form-group"><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="inEndDate"></div>
                <button class="btn btn-blue" id="btn-run-all" onclick="runRankingBacktest()">ğŸš€ å¼€å§‹æ’åå›æµ‹</button>
            </div>
            
            <div class="toggle-link" onclick="toggleAdvSettings()">ğŸ›  ç­–ç•¥å‚æ•°è®¾ç½® â–¼</div>
            <div id="adv-settings">
                <div class="form-row">
                    <div class="form-group">
                        <label>ğŸ† æŒä»“æ’åå‰ç™¾åˆ†æ¯” (%)</label>
                        <input type="number" id="pTopPercent" step="1" value="5">
                        <div style="font-size:10px;color:#999">ä¾‹å¦‚å¡«5ï¼šåªæŒæœ‰è‚¡æ¯ç‡æ’åå‰ 5% çš„è‚¡ç¥¨</div>
                    </div>
                    <div class="form-group">
                        <label>ğŸ”„ è°ƒä»“é¢‘ç‡</label>
                        <select id="pRebalanceFreq">
                            <option value="1">æ¯æ—¥æ£€æŸ¥</option>
                            <option value="5">æ¯å‘¨æ£€æŸ¥</option>
                            <option value="20" selected>æ¯æœˆæ£€æŸ¥</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="batch-progress" style="display:none; margin:12px 0; padding:10px; background:#e3f2fd; color:#0056b3; font-size:13px; border-radius:4px; text-align:center;"></div>

            <!-- ç»“æœå®¹å™¨ -->
            <div id="results-container" style="display:none; margin-top:15px;">
                <!-- ç»„åˆç­–ç•¥ -->
                <div id="portfolio-section" style="margin-bottom:15px;">
                    <div class="stat-grid">
                        <div class="stat-item"><div class="stat-val" id="port-ret">--</div><div class="stat-lbl">Topç­–ç•¥æ€»æ”¶ç›Š</div></div>
                        <div class="stat-item"><div class="stat-val" id="port-dd">--</div><div class="stat-lbl">æœ€å¤§å›æ’¤</div></div>
                        <div class="stat-item"><div class="stat-val" id="port-yield">--</div><div class="stat-lbl">å¹³å‡æŒä»“è‚¡æ¯ç‡</div></div>
                    </div>
                    <div id="portfolio-chart" style="width: 100%; height: 350px;"></div>
                </div>

                <!-- æ”¶ç›Šæ’è¡Œæ¦œ -->
                <div id="batch-summary-box" style="margin-bottom:15px;">
                    <h5 style="margin:0 0 10px 0;color:#555;">ğŸ“‹ æ›¾å…¥é€‰ Top æ¦œå•çš„è‚¡ç¥¨</h5>
                    <div class="summary-wrapper">
                        <table class="summary-table">
                            <thead><tr><th>è‚¡ç¥¨</th><th>å¹³å‡è‚¡æ¯ç‡</th><th>ç­–ç•¥æ”¶ç›Š</th><th>æŒä»“å¤©æ•°</th></tr></thead>
                            <tbody id="summary-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div> 
            
            <!-- å•åªè¯¦æƒ… -->
            <div id="detail-view" style="display:none; border-top: 2px dashed #eee; margin-top: 20px; padding-top: 15px;">
                <h4 style="margin:0 0 10px 0;" id="detail-title">è¯¦ç»†ä¿¡æ¯</h4>
                <div id="chart-box" style="width: 100%; height: 400px;"></div>
                <div style="margin-top:20px;">
                    <div style="font-weight:bold; color:#555; margin-bottom:5px;">ğŸ“œ äº¤æ˜“æ—¥å¿—</div>
                    <div style="max-height: 300px; overflow: auto; border:1px solid #eee; border-radius:6px;">
                        <table class="log-table">
                            <thead style="background:#f9f9f9;"><tr><th>æ—¥æœŸ</th><th>åŠ¨ä½œ</th><th>è‚¡æ¯ç‡</th><th>è¯´æ˜</th></tr></thead>
                            <tbody id="log-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="token-modal" class="modal">
    <div class="modal-box">
        <h3>ğŸ”‘ GitHub Token</h3>
        <input type="text" id="gh-token-input" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:15px;" placeholder="ghp_xxxx...">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-gray" style="flex:1" onclick="document.getElementById('token-modal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-blue" style="flex:1" onclick="saveToken()">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
    // === åŸºç¡€é…ç½® ===
    const GITHUB_CONFIG = { username: "dlezywj-cell", repo: "backtest", path: "dividend_config.json", branch: "main" };
    const PROXY = 'https://corsproxy.io/?'; 
    let stocks = JSON.parse(localStorage.getItem('divStocks')) || [];
    let myChart = null, portfolioChart = null;
    let batchResults = []; 
    // å…¨å±€å­˜å‚¨æ‰€æœ‰è‚¡ç¥¨çš„æ¯æ—¥æ•°æ®ï¼Œç”¨äºæ¨ªå‘æ’å
    let globalMarketData = {}; // { "2023-01-01": [ {index:0, yield: 5.2}, ... ] }

    function initDates() {
        const d = new Date();
        document.getElementById('inEndDate').value = d.toISOString().split('T')[0];
        d.setFullYear(d.getFullYear() - 1);
        document.getElementById('inStartDate').value = d.toISOString().split('T')[0];
    }
    initDates();
    renderTable();
    checkUnsavedStatus();

    // === UI & Excel éƒ¨åˆ† (ä¿æŒä¸å˜) ===
    function checkUnsavedStatus() {
        const dirty = localStorage.getItem('divHasUnsavedChanges') === 'true';
        const btn = document.getElementById('btn-push');
        if (dirty) { btn.classList.add('unsaved'); btn.innerHTML = "ğŸ”´ å¾…åŒæ­¥é…ç½®"; } 
        else { btn.classList.remove('unsaved'); btn.innerHTML = "ğŸš€ 2. ä¿å­˜é…ç½®åˆ° GitHub"; }
    }
    function setLocalChanges(isDirty) { localStorage.setItem('divHasUnsavedChanges', isDirty); checkUnsavedStatus(); }
    function toggleCard(id) { 
        const el = document.getElementById(id); el.classList.toggle('open'); 
        if(el.classList.contains('open') && (myChart || portfolioChart)) { setTimeout(() => { if(myChart) myChart.resize(); if(portfolioChart) portfolioChart.resize(); }, 200); }
    }
    function toggleAdvSettings() { const el = document.getElementById('adv-settings'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    
    // ä¼˜åŒ–çš„ Excel å¯¼å…¥
    function importFromExcel(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1}); 
                if(jsonData.length < 2) throw new Error("Excel æ•°æ®å¤ªå°‘");
                
                const headers = jsonData[0].map(h => String(h).trim());
                const codeIdx = headers.findIndex(h => /ä»£ç |Code/i.test(h));
                const nameIdx = headers.findIndex(h => /åç§°|Name/i.test(h));
                let divIdx = headers.indexOf('åˆ†çº¢'); 
                if (divIdx === -1) divIdx = headers.findIndex(h => ['åˆ†çº¢æ€»é¢', 'ç°é‡‘åˆ†çº¢', 'Total Dividend'].includes(h));
                if (divIdx === -1) divIdx = headers.findIndex(h => /åˆ†çº¢|Dividend|æ´¾æ¯/.test(h.toUpperCase()) && !/æ¯è‚¡|EPS/.test(h.toUpperCase()));
                
                if(codeIdx === -1 || divIdx === -1) return alert("âŒ æ— æ³•è¯†åˆ«ã€ä»£ç ã€‘æˆ–ã€åˆ†çº¢ã€‘åˆ—ã€‚");

                let newStocks = [];
                let today = new Date().toISOString().split('T')[0];
                let smallValueCount = 0; 
                for(let i=1; i<jsonData.length; i++) {
                    const row = jsonData[i]; if(!row[codeIdx]) continue; 
                    let rawCode = String(row[codeIdx]).trim();
                    let suffix = /^\d{5}$/.test(rawCode) ? ".HK" : (/^\d{6}$/.test(rawCode) ? (rawCode.startsWith('6') ? ".SH" : ".SZ") : "");
                    if(!rawCode.includes('.') && suffix) rawCode += suffix;
                    
                    let divVal = 0, rawDiv = row[divIdx];
                    if (rawDiv) {
                        let strVal = String(rawDiv).replace(/,/g, '');
                        let mul = 1;
                        if (strVal.includes('äº¿')) { mul = 1e8; strVal = strVal.replace('äº¿', ''); } else if (strVal.includes('ä¸‡')) { mul = 1e4; strVal = strVal.replace('ä¸‡', ''); }
                        divVal = parseFloat(strVal) * mul;
                    }
                    if(divVal > 0 && divVal < 1e6) smallValueCount++;
                    newStocks.push({ code: rawCode, name: (nameIdx!==-1 && row[nameIdx]) || rawCode, dividend: divVal || 0, lastMod: today });
                }
                if(smallValueCount > newStocks.length * 0.5 && confirm(`âš ï¸ åˆ†çº¢æ•°å€¼åå°ï¼Œæ˜¯å¦è‡ªåŠ¨ä¹˜ä»¥1äº¿ï¼Ÿ`)) newStocks.forEach(s => s.dividend *= 1e8);
                
                if(confirm(`è§£æ ${newStocks.length} æ¡ï¼Œè¦†ç›–åˆ—è¡¨ï¼Ÿ`)) {
                    stocks = newStocks; localStorage.setItem('divStocks', JSON.stringify(stocks)); renderTable(); setLocalChanges(true);
                }
            } catch(err) { alert("Excel è§£æå¤±è´¥: " + err.message); }
            input.value = ''; 
        };
        reader.readAsArrayBuffer(file);
    }
    
    function renderTable() {
        const tb = document.getElementById('stock-tbody'); 
        tb.innerHTML = stocks.map((s, i) => `<tr><td><b>${s.name}</b> <span style="color:#999;font-size:12px">${s.code}</span></td><td>${(s.dividend/1e8).toFixed(2)}äº¿</td><td style="text-align:center;"><button class="btn btn-edit-yellow btn-icon-square" onclick="editStock(${i})">âœ</button> <button class="btn btn-del-red btn-icon-square" onclick="delStock(${i})">âœ•</button></td><td style="text-align:center;"><input type="checkbox" class="stock-chk" value="${i}" checked></td></tr>`).join('');
        document.getElementById('list-count').innerText = `(${stocks.length})`;
        checkAllState();
    }
    function editStock(i) { const s = stocks[i]; document.getElementById('inName').value=s.name; document.getElementById('inCode').value=s.code; document.getElementById('inDividend').value=s.dividend; document.getElementById('card-config').scrollIntoView({behavior:'smooth'}); }
    function saveStock() {
        const code = document.getElementById('inCode').value.trim(); const name = document.getElementById('inName').value.trim(); const div = parseFloat(document.getElementById('inDividend').value);
        if(!code || isNaN(div)) return alert("è¯·å¡«å†™å®Œæ•´");
        const idx = stocks.findIndex(s => s.code === code);
        const item = { code, name, dividend: div, lastMod: new Date().toISOString().split('T')[0] };
        if(idx>=0) stocks[idx]=item; else stocks.push(item);
        localStorage.setItem('divStocks', JSON.stringify(stocks)); renderTable(); setLocalChanges(true);
        document.getElementById('inCode').value=''; document.getElementById('inName').value=''; document.getElementById('inDividend').value='';
    }
    function delStock(i) { if(confirm("ç¡®è®¤åˆ é™¤ï¼Ÿ")) { stocks.splice(i, 1); localStorage.setItem('divStocks', JSON.stringify(stocks)); renderTable(); setLocalChanges(true); } }
    function toggleAllStocks(el) { document.querySelectorAll('.stock-chk').forEach(chk => chk.checked = el.checked); }
    function checkAllState() { const all = document.querySelectorAll('.stock-chk'); document.getElementById('check-all').checked = (all.length > 0 && all.length === document.querySelectorAll('.stock-chk:checked').length); }
    document.addEventListener('change', e=>{ if(e.target.classList.contains('stock-chk')) checkAllState(); });

    // === GitHub (ä¿æŒä¸å˜) ===
    function safeB64ToUtf8(str) { return decodeURIComponent(escape(window.atob(str.replace(/\s/g, '')))); }
    function utf8ToB64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
    async function uploadToGithub() {
        let token = localStorage.getItem("github_token"); if (!token) { document.getElementById('token-modal').style.display='flex'; return; }
        const btn = document.getElementById('btn-push'); btn.innerHTML = "â³"; btn.disabled = true;
        try {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
            const get = await fetch(url, { headers: { "Authorization": `token ${token}` } });
            let sha = get.ok ? (await get.json()).sha : null;
            await fetch(url, { method: "PUT", headers: { "Authorization": `token ${token}` }, body: JSON.stringify({ message: "Update", content: utf8ToB64(JSON.stringify(stocks,null,2)), sha }) });
            alert("âœ… æˆåŠŸ"); setLocalChanges(false);
        } catch (e) { alert("å¤±è´¥: " + e.message); if(e.message.includes("401")) localStorage.removeItem("github_token"); } 
        finally { btn.innerHTML = "ğŸš€ 2. ä¿å­˜é…ç½®åˆ° GitHub"; btn.disabled = false; checkUnsavedStatus(); }
    }
    async function syncFromGithub() {
        let token = localStorage.getItem("github_token"); const btn = document.getElementById('btn-pull'); btn.innerHTML = "â³"; btn.disabled = true;
        try {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
            let res = await fetch(url, { headers: token ? { "Authorization": `token ${token}` } : {} });
            let data = res.ok ? JSON.parse(safeB64ToUtf8((await res.json()).content)) : await (await fetch(`https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}?t=${Date.now()}`)).json();
            if(Array.isArray(data) && confirm(`è¦†ç›–æœ¬åœ° ${stocks.length} æ¡æ•°æ®ï¼Ÿ`)) { stocks = data; localStorage.setItem('divStocks', JSON.stringify(stocks)); renderTable(); setLocalChanges(false); }
        } catch (e) { alert("å¤±è´¥: " + e.message); } finally { btn.innerHTML = "â˜ï¸ æ‹‰å–é…ç½®"; btn.disabled = false; }
    }
    function saveToken() { const t = document.getElementById('gh-token-input').value.trim(); if(t) { localStorage.setItem('github_token', t); document.getElementById('token-modal').style.display='none'; uploadToGithub(); } }

    // === æ ¸å¿ƒï¼šæ’è¡Œæ¦œå›æµ‹é€»è¾‘ ===
    const getEmSecId = c => { let raw = c.replace(/\.[A-Z]+$/, ''); if (c.includes('.HK') || /^\d{5}$/.test(raw)) return '116.' + raw.padStart(5, '0'); if (raw.startsWith('6')) return '1.' + raw; return '0.' + raw; };
    
    // é˜¶æ®µ1ï¼šé¢„å¤„ç† - è·å–å•åªè‚¡ç¥¨çš„æ¯æ—¥è‚¡æ¯ç‡æ•°æ®
    async function fetchStockDailyData(stock, startDate, endDate) {
        let emSecId = getEmSecId(stock.code); 
        let emCode = emSecId.split('.')[1];
        
        // è·å–æ€»è‚¡æœ¬
        const snapUrl = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${emSecId}&fields=f2,f20&invt=2&fltt=2`;
        const snapRes = await fetch(PROXY + encodeURIComponent(snapUrl));
        const snapJson = await snapRes.json();
        let totalShares = 0;
        if (snapJson.data?.diff) {
            let d = Array.isArray(snapJson.data.diff) ? snapJson.data.diff[0] : snapJson.data.diff[emCode];
            if(d && d.f2 > 0) totalShares = d.f20 / d.f2;
        }
        if(!totalShares) return null; // æ— æ³•è·å–è‚¡æœ¬ï¼Œè·³è¿‡

        // è·å–Kçº¿
        const kUrl = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${emSecId}&fields1=f1&fields2=f51,f53&klt=101&fqt=1&end=20500101&lmt=1000`;
        const kRes = await fetch(PROXY + encodeURIComponent(kUrl));
        const kJson = await kRes.json();
        const klines = kJson?.data?.klines || [];
        
        let dailyData = [];
        const totalDiv = stock.dividend;
        
        klines.forEach(k => {
            const parts = k.split(',');
            const date = parts[0];
            if (date >= startDate && date <= endDate) {
                const close = parseFloat(parts[1]);
                const mv = close * totalShares;
                const dy = (totalDiv / mv) * 100; // è‚¡æ¯ç‡ %
                dailyData.push({ date, close, dy });
            }
        });
        return dailyData;
    }

    // é˜¶æ®µ2 & 3ï¼šä¸»å›æµ‹æµç¨‹
    async function runRankingBacktest() {
        const checkedBoxes = document.querySelectorAll('.stock-chk:checked');
        if(checkedBoxes.length === 0) return alert("è¯·è‡³å°‘å‹¾é€‰ä¸€åªè‚¡ç¥¨");
        const selectedIndices = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

        const btn = document.getElementById('btn-run-all');
        const progress = document.getElementById('batch-progress');
        const startDate = document.getElementById('inStartDate').value;
        const endDate = document.getElementById('inEndDate').value;
        const topPercent = parseFloat(document.getElementById('pTopPercent').value) || 5;
        const rebalanceFreq = parseInt(document.getElementById('pRebalanceFreq').value) || 20;

        btn.innerText = "â³ æ­£åœ¨æ‹‰å–æ•°æ®..."; btn.disabled = true;
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('summary-tbody').innerHTML = '';
        progress.style.display = 'block';

        // 1. ä¸‹è½½å¹¶æ•´ç†æ‰€æœ‰æ•°æ®
        let allStockData = {}; // index -> [dailyData]
        let dateYieldMap = {}; // date -> [ {index, dy} ]
        let successCount = 0;

        for(let step=0; step < selectedIndices.length; step++) {
            const idx = selectedIndices[step];
            const s = stocks[idx];
            progress.innerHTML = `æ­£åœ¨åˆ†æå¸‚åœºæ•°æ® <b>${s.name}</b> (${step+1}/${selectedIndices.length})...`;
            try {
                const daily = await fetchStockDailyData(s, startDate, endDate);
                if (daily && daily.length > 0) {
                    allStockData[idx] = daily;
                    // å¡«å……æ—¥æœŸæ˜ å°„ï¼Œæ–¹ä¾¿åç»­æ¨ªå‘æ’å
                    daily.forEach(d => {
                        if (!dateYieldMap[d.date]) dateYieldMap[d.date] = [];
                        dateYieldMap[d.date].push({ index: idx, dy: d.dy });
                    });
                    successCount++;
                }
            } catch(e) { console.error(s.name, e); }
            // ç®€å•èŠ‚æµ
            if(step % 10 === 0) await new Promise(r => setTimeout(r, 20)); 
        }

        progress.innerHTML = `âœ… æ•°æ®å°±ç»ª (æœ‰æ•ˆè‚¡ç¥¨: ${successCount})ã€‚æ­£åœ¨è®¡ç®—å…¨å¸‚åœºæ’å...`;

        // 2. è®¡ç®—æ¯æ—¥çš„â€œå…¥å›´åˆ†æ•°çº¿â€ (Thresholds)
        let dailyThresholds = {}; // date -> minYieldToBuy
        const sortedDates = Object.keys(dateYieldMap).sort();
        
        sortedDates.forEach(date => {
            const list = dateYieldMap[date];
            // é™åºæ’åˆ—
            list.sort((a, b) => b.dy - a.dy);
            
            // è®¡ç®—å‰ N% çš„ä½ç½®
            const cutoffIndex = Math.floor(list.length * (topPercent / 100));
            // è¾¹ç•Œä¿æŠ¤ï¼šè‡³å°‘é€‰1åª
            const targetIdx = Math.max(0, Math.min(cutoffIndex, list.length - 1));
            const cutoffYield = list[targetIdx].dy;
            
            dailyThresholds[date] = cutoffYield;
        });

        // 3. å›æµ‹æ¯åªè‚¡ç¥¨ (ä¼ å…¥åŠ¨æ€é˜ˆå€¼)
        batchResults = [];
        const indices = Object.keys(allStockData);
        
        indices.forEach(strIdx => {
            const idx = parseInt(strIdx);
            const stock = stocks[idx];
            const daily = allStockData[idx];
            
            let history = [], logs = [];
            let nav = 1.0, hold = 0, daysHeld = 0;
            let sumHeldYield = 0, yieldCount = 0;
            
            // åˆå§‹åŒ–
            history.push({ date: daily[0].date, nav: 1.0, close: daily[0].close, pos: 0, dy: daily[0].dy });

            for(let i=1; i<daily.length; i++) {
                const today = daily[i];
                const prev = daily[i-1];
                const date = today.date;
                
                // æ ¸å¿ƒç­–ç•¥ï¼šåªæœ‰åœ¨è°ƒä»“æ—¥æ‰åˆ¤æ–­
                let action = null, reason = "";
                
                // æ¨¡æ‹Ÿæ¯æœˆ/æ¯å‘¨è°ƒä»“
                // ç®€å•è¿‘ä¼¼ï¼šç”¨ç´¢å¼•å–æ¨¡ã€‚æ›´å¥½çš„æ–¹å¼æ˜¯åˆ¤æ–­æœˆä»½å˜åŒ–ï¼Œä½†è¿™é‡Œå¤Ÿç”¨äº†
                if (i % rebalanceFreq === 0) {
                    const cutoff = dailyThresholds[date] || 999; // å½“å¤©å¸‚åœºçš„åŠæ ¼çº¿
                    
                    if (today.dy >= cutoff) {
                        // è¾¾æ ‡
                        if (hold === 0) {
                            hold = 1; 
                            action = `<span class="badge bg-red">æ’åä¹°å…¥</span>`;
                            reason = `è‚¡æ¯${today.dy.toFixed(2)}% â‰¥ å¸‚åœºTop${topPercent}%çº¿(${cutoff.toFixed(2)}%)`;
                        }
                    } else {
                        // ä¸è¾¾æ ‡
                        if (hold > 0) {
                            hold = 0;
                            action = `<span class="badge bg-green">è½®åŠ¨å–å‡º</span>`;
                            reason = `è‚¡æ¯${today.dy.toFixed(2)}% < å¸‚åœºTop${topPercent}%çº¿(${cutoff.toFixed(2)}%)`;
                        }
                    }
                }

                // å‡€å€¼æ›´æ–°
                const r = (today.close / prev.close) - 1;
                nav = nav * (1 + hold * r);
                
                if (hold > 0) { 
                    daysHeld++; 
                    sumHeldYield += today.dy; 
                    yieldCount++; 
                }
                
                if (action) logs.push({ date, action, dy: today.dy.toFixed(2)+'%', reason });
                history.push({ date, nav, close: today.close, pos: hold, dy: today.dy });
            }

            // åªæœ‰æ›¾ç»æŒä»“è¿‡çš„è‚¡ç¥¨æ‰è®°å½•åˆ°ç»“æœä¸­ï¼Œé¿å…è¡¨æ ¼å¤ªé•¿
            if (daysHeld > 0 || logs.length > 0) {
                batchResults.push({
                    index: idx,
                    stockName: stock.name,
                    stockCode: stock.code,
                    history: history,
                    logs: logs,
                    stats: {
                        ret: (nav - 1) * 100,
                        avgYield: yieldCount > 0 ? (sumHeldYield / yieldCount) : 0,
                        daysHeld: daysHeld
                    }
                });
            }
        });

        // 4. æ¸²æŸ“ç»“æœ
        progress.style.display = 'none';
        btn.innerText = "ğŸš€ å¼€å§‹æ’åå›æµ‹"; btn.disabled = false;
        
        if(batchResults.length > 0) {
            document.getElementById('results-container').style.display = 'block';
            
            // æ’åºï¼šæŒ‰æŒä»“å¤©æ•°æˆ–æ”¶ç›Šæ’åºï¼Œæ–¹ä¾¿çœ‹å“ªäº›è‚¡ç¥¨è¢«é€‰ä¸­äº†
            batchResults.sort((a,b) => b.stats.daysHeld - a.stats.daysHeld);
            
            const tbody = document.getElementById('summary-tbody');
            batchResults.forEach(res => {
                const tr = document.createElement('tr');
                tr.onclick = () => showDetail(res.index);
                const cRet = res.stats.ret >= 0 ? 'val-pos' : 'val-neg';
                tr.innerHTML = `<td><b>${res.stockName}</b></td><td>${res.stats.avgYield.toFixed(2)}%</td><td class="${cRet}">${res.stats.ret.toFixed(1)}%</td><td>${res.stats.daysHeld}å¤©</td>`;
                tbody.appendChild(tr);
            });

            runPortfolioStrategy(sortedDates);
            showDetail(batchResults[0].index);
        } else {
            alert("åœ¨é€‰å®šæ—¶é—´å†…ï¼Œæ²¡æœ‰è‚¡ç¥¨æ»¡è¶³ Top N% æ¡ä»¶ï¼ˆå¯èƒ½æ˜¯æ•°æ®ä¸è¶³ï¼‰");
        }
    }

    // === è¯¦æƒ…ä¸ç»„åˆå›¾è¡¨ ===
    function showDetail(index) {
        const res = batchResults.find(r => r.index === index); if(!res) return;
        document.getElementById('detail-view').style.display = 'block';
        document.getElementById('detail-title').innerText = `${res.stockName} (${res.stockCode}) - ç­–ç•¥ç›ˆäº: ${res.stats.ret.toFixed(2)}%`;
        
        const dom = document.getElementById('chart-box'); 
        if(myChart) myChart.dispose(); myChart = echarts.init(dom);
        
        const dates = res.history.map(h => h.date);
        myChart.setOption({
            tooltip: { trigger: 'axis', axisPointer: {type:'cross'} },
            legend: { data: ['å‡€å€¼','è‚¡ä»·','è‚¡æ¯ç‡(å³)','æŒä»“çŠ¶æ€'], top:0 },
            grid: [{left:'10%',right:'10%',top:'10%',height:'60%'}, {left:'10%',right:'10%',top:'75%',height:'15%'}],
            xAxis: [{data:dates, gridIndex:0}, {data:dates, gridIndex:1, show:false}],
            yAxis: [{name:'å‡€å€¼/è‚¡ä»·'}, {name:'è‚¡æ¯ç‡%', position:'right', splitLine:{show:false}}, {gridIndex:1, max:1.2, show:false}],
            series: [
                {name:'å‡€å€¼', type:'line', data:res.history.map(h=>h.nav), itemStyle:{color:'#d32f2f'}, lineStyle:{width:2}},
                {name:'è‚¡ä»·', type:'line', data:res.history.map(h=>h.close), itemStyle:{color:'#ccc'}, lineStyle:{width:1}},
                {name:'è‚¡æ¯ç‡(å³)', type:'line', yAxisIndex:1, data:res.history.map(h=>h.dy), itemStyle:{color:'#fd7e14'}, lineStyle:{width:1, type:'dashed'}},
                {name:'æŒä»“çŠ¶æ€', type:'area', xAxisIndex:1, yAxisIndex:2, data:res.history.map(h=>h.pos), itemStyle:{color:'#28a745', opacity:0.3}, step:'end'}
            ]
        });

        document.getElementById('log-tbody').innerHTML = res.logs.map(l => `<tr><td>${l.date}</td><td style="text-align:center">${l.action}</td><td style="text-align:center">${l.dy}</td><td style="color:#666;font-size:11px;">${l.reason}</td></tr>`).join('');
    }

    function runPortfolioStrategy(allDates) {
        // è®¡ç®—æ¯ä¸€å¤©çš„ç»„åˆå‡€å€¼
        let portHist = [];
        let nav = 1.0;
        let maxDD = 0, peak = 1.0;

        for (let i = 1; i < allDates.length; i++) {
            const date = allDates[i];
            const prevDate = allDates[i-1];
            
            let dailySumRet = 0;
            let activeCount = 0;
            let dailyYieldSum = 0;

            // éå†æ‰€æœ‰æœ‰æŒä»“çš„è‚¡ç¥¨
            batchResults.forEach(res => {
                // æ‰¾åˆ°è¯¥è‚¡ç¥¨åœ¨ yesterday çš„çŠ¶æ€
                // è¿™é‡Œç”¨ç®€åŒ–çš„ findï¼Œå®é™…å¯ä»¥ç”¨ map ä¼˜åŒ–æ€§èƒ½ï¼Œä½†å‡ åƒæ¬¡å¾ªç¯åœ¨ JS é‡Œå¾ˆå¿«
                const hPrev = res.history.find(h => h.date === prevDate);
                const hNow = res.history.find(h => h.date === date);
                
                if (hPrev && hNow && hPrev.pos > 0) {
                    const r = (hNow.close / hPrev.close) - 1;
                    dailySumRet += r;
                    activeCount++;
                    dailyYieldSum += hNow.dy;
                }
            });

            // èµ„é‡‘ç­‰æƒåˆ†é…ç»™æ‰€æœ‰æŒä»“è‚¡
            if (activeCount > 0) {
                const avgRet = dailySumRet / activeCount;
                nav = nav * (1 + avgRet);
            }
            // else ç©ºä»“ï¼Œå‡€å€¼ä¸å˜

            if (nav > peak) peak = nav;
            const dd = (peak - nav) / peak; if (dd > maxDD) maxDD = dd;
            
            portHist.push({ 
                date, 
                nav, 
                avgYield: activeCount > 0 ? (dailyYieldSum / activeCount) : 0 
            });
        }

        const last = portHist[portHist.length - 1];
        if(!last) return;

        document.getElementById('port-ret').innerText = ((last.nav - 1)*100).toFixed(2) + "%";
        document.getElementById('port-ret').className = last.nav >= 1 ? 'stat-val win' : 'stat-val loss';
        document.getElementById('port-dd').innerText = (maxDD * 100).toFixed(2) + "%";
        document.getElementById('port-yield').innerText = last.avgYield.toFixed(2) + "%";

        const dom = document.getElementById('portfolio-chart');
        if(portfolioChart) portfolioChart.dispose(); portfolioChart = echarts.init(dom);
        
        portfolioChart.setOption({
            tooltip: { trigger: 'axis' },
            legend: { data: ['Topç»„åˆå‡€å€¼', 'å¹³å‡è‚¡æ¯ç‡(å³)'] },
            xAxis: { data: portHist.map(h=>h.date) },
            yAxis: [{name:'å‡€å€¼'}, {name:'è‚¡æ¯ç‡%', position:'right', splitLine:{show:false}}],
            series: [
                {name:'Topç»„åˆå‡€å€¼', type:'line', data:portHist.map(h=>h.nav), itemStyle:{color:'#d32f2f'}, areaStyle:{opacity:0.1}},
                {name:'å¹³å‡è‚¡æ¯ç‡(å³)', type:'line', yAxisIndex:1, data:portHist.map(h=>h.avgYield), itemStyle:{color:'#1976d2'}, lineStyle:{width:1, type:'dashed'}}
            ]
        });
    }
</script>
</body>
</html>
