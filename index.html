<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜è‚¡æ¯è½®åŠ¨ç­–ç•¥ (Excelä¸¥æ ¼åŒ¹é…ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- å¼•å…¥ SheetJS ç”¨äºè§£æ Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* === åŸºç¡€å˜é‡ === */
        :root { --primary: #007bff; --bg: #f4f6f9; --card: #fff; --text: #333; --border: #eee; --selected: #e3f2fd; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 80px; font-size: 14px; }
        .container { max-width: 800px; margin: 0 auto; }

        /* === å¡ç‰‡æ¡†æ¶ === */
        .card { background: var(--card); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; overflow: hidden; transition: all 0.3s; }
        .card-header { padding: 12px 15px; background: #fff; border-bottom: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 15px; user-select: none; cursor: pointer;}
        .header-title { flex: 1; display: flex; align-items: center; gap: 5px; }
        
        .card-body { display: none; padding: 15px; }
        .card.open .card-body { display: block; }
        .card.open .card-header { border-bottom-color: var(--border); }
        
        .arrow { font-size: 12px; color: #999; transition: transform 0.3s; }
        .card.open .arrow { transform: rotate(180deg); }

        /* === åŒºåŸŸæŠ˜å å¤´ (Section) === */
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer; margin-bottom: 5px; user-select: none; border: 1px solid #eee; transition: background 0.2s; }
        .section-header:active { background: #e9ecef; }
        .section-header span { font-weight: 600; font-size: 13px; color: #555; }
        .section-header .header-arrow { transform: rotate(0deg); transition: transform 0.3s; }
        .section-header.expanded .header-arrow { transform: rotate(180deg); } 
        .section-body { display: block; animation: fadeIn 0.3s; padding: 5px; border: 1px solid #f8f9fa; border-top: none; margin-bottom: 15px; }
        .section-body.collapsed { display: none; } 
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* === è¡¨å•ä¸æŒ‰é’® === */
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .form-group { flex: 1; min-width: 0; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-size:13px; background:#fff;}
        .form-group input:focus { border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.1); }

        .run-bar { display: flex; gap: 10px; align-items: flex-end; background:#f8f9fa; padding:10px; border-radius:6px; margin-top:0; }
        @media (max-width: 600px) {
            .run-bar { flex-wrap: wrap; }
            .run-bar .form-group { min-width: 45%; flex: 1; }
            .run-bar #btn-run-all { width: 100%; margin-top: 8px; padding: 12px; font-size: 16px; font-weight: bold; }
        }

        #adv-settings { background: #fff; border: 1px dashed #ddd; padding: 10px; border-radius: 6px; margin-top: 5px; display: none; }
        .toggle-link { display: block; text-align: right; margin-top: 5px; margin-bottom: 5px; color: #007bff; font-size: 12px; cursor: pointer; user-select: none; }

        .btn { border: none; border-radius: 6px; padding: 10px; color: #fff; cursor: pointer; font-weight: 500; display:flex; align-items:center; justify-content:center; transition: opacity 0.2s; }
        .btn:active { opacity: 0.8; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        .btn-blue { background: #007bff; } .btn-green { background: #28a745; } .btn-purple { background: #6f42c1; } .btn-gray { background: #6c757d; }
        .btn-orange { background: #fd7e14; transition: all 0.3s ease; }
        .btn-orange.unsaved { background-color: #dc3545 !important; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
        
        .btn-icon-square { width: 28px; height: 28px; padding: 0; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; }
        .btn-edit-yellow { background: #ffca28; color: #333; }
        .btn-del-red { background: #ef5350; color: #fff; }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; margin-bottom: 15px; margin-top: 15px; }
        .stat-item { background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .stat-val { font-size: 16px; font-weight: bold; }
        .stat-lbl { font-size: 11px; color: #888; }
        .win { color: #d32f2f; } .loss { color: #2e7d32; }
        
        .summary-wrapper { overflow-x: auto; margin-bottom: 15px; border: 1px solid #eee; border-radius: 6px; max-height: 400px; }
        .summary-table { width: 100%; font-size: 13px; border-collapse: collapse; background: #fff; min-width: 300px; }
        .summary-table th { background: #f1f3f5; padding: 10px 8px; color: #555; font-weight: 600; text-align: right; position: sticky; top: 0; z-index: 10; }
        .summary-table th:first-child { text-align: left; }
        .summary-table td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: right; }
        .summary-table td:first-child { text-align: left; }
        .summary-table tr:hover { background: #f9f9f9; cursor: pointer; }
        .summary-table tr.selected { background: #e3f2fd !important; border-left: 3px solid #007bff; }
        .val-pos { color: #d32f2f; } .val-neg { color: #2e7d32; }

        .base-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .base-table th { background: #f8f9fa; padding: 10px; text-align: left; font-size: 12px; color:#666; border-bottom: 1px solid #ddd; }
        .base-table td { padding: 12px 5px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; vertical-align: middle; }
        
        .log-table { width: 100%; min-width: 600px; border-collapse: collapse; }
        .log-table th { background: #fff; color: #666; font-size: 12px; position: sticky; top: 0; border-bottom: 2px solid #eee; text-align: left; padding: 8px 5px; z-index: 5; }
        .log-table td { padding: 8px 5px; border-bottom: 1px solid #f0f0f0; font-size: 12px; vertical-align: middle; }
        
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #fff; font-weight: normal; }
        .bg-red { background: #d32f2f; } .bg-green { background: #2e7d32; } .bg-gray { background: #999; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .modal-box { background: #fff; padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; }
        
        /* Excel å¯¼å…¥æŒ‰é’®æ ·å¼ */
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
<!-- é…ç½®å¡ç‰‡ -->
<div class="card open" id="card-config">
    <div class="card-header" onclick="toggleCard('card-config')">
        <div class="header-title"><span>âš™ï¸ ç­–ç•¥ä¸æ•°æ®</span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body">
        <div style="background:#fff3cd; color:#856404; padding:10px; border-radius:6px; font-size:12px; margin-bottom:15px; border:1px solid #ffeeba;">
            <b>ğŸ’¡ æç¤ºï¼š</b> ç­–ç•¥å·²åˆ‡æ¢ä¸º [é«˜è‚¡æ¯è½®åŠ¨]ã€‚<br>è¯·å¯¼å…¥åŒ…å«ã€ä»£ç ã€åç§°ã€åˆ†çº¢ã€‘åˆ—çš„ Excel è¡¨æ ¼ã€‚åˆ†çº¢å¡«å†™å¹´åº¦æ€»ç°é‡‘åˆ†çº¢(å…ƒ)ã€‚
        </div>
        
        <div class="form-row">
            <div class="file-input-wrapper">
                <button class="btn btn-green" style="width:100%">ğŸ“‚ 1. ä» Excel å¯¼å…¥è‚¡ç¥¨ä¸åˆ†çº¢æ•°æ®</button>
                <input type="file" id="excel-file" accept=".xlsx, .xls, .csv" onchange="importFromExcel(this)">
            </div>
        </div>
        
        <!-- æ‰‹åŠ¨ä¿®æ”¹åŒº -->
        <div class="form-row" style="margin-top:10px;">
            <div class="form-group" style="flex:2"><label>è‚¡ç¥¨åç§°</label><input type="text" id="inName" placeholder="å¦‚: å†œä¸šé“¶è¡Œ"></div>
            <div class="form-group" style="flex:1.5"><label>ä»£ç </label><input type="text" id="inCode" placeholder="å¦‚: 601288"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>å¹´åº¦æ€»ç°é‡‘åˆ†çº¢(å…ƒ)</label><input type="number" id="inDividend" placeholder="ä¾‹å¦‚: 70000000000"></div>
            <button class="btn btn-blue" id="btn-save-single" style="margin-bottom:1px;" onclick="saveStock()">â• æ·»åŠ /ä¿å­˜ä¿®æ”¹</button>
        </div>

        <div style="display:flex; gap:10px; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn btn-purple" style="flex:1" id="btn-pull" onclick="syncFromGithub()">â˜ï¸ æ‹‰å–é…ç½®</button>
            <button class="btn btn-orange" style="flex:1" id="btn-push" onclick="uploadToGithub()">ğŸš€ 2. ä¿å­˜é…ç½®åˆ° GitHub</button>
        </div>
    </div>
</div>

<!-- åˆ—è¡¨å¡ç‰‡ -->
<div class="card open" id="card-list">
    <div class="card-header" onclick="toggleCard('card-list')">
        <div class="header-title"><span>ğŸ“‹ ç›‘æ§æ± </span><span id="list-count" style="font-weight:normal;margin-left:5px;color:#999;"></span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body" style="padding:0">
        <div style="max-height: 350px; overflow-y: auto;">
            <table class="base-table">
                <thead>
                    <tr>
                        <th>è‚¡ç¥¨ä¿¡æ¯</th>
                        <th style="width:35%;">ç™»è®°åˆ†çº¢(å…ƒ)</th>
                        <th style="text-align:center; width:90px;">æ“ä½œ</th>
                        <th style="width:40px; text-align:center;"><input type="checkbox" id="check-all" onchange="toggleAllStocks(this)" checked></th>
                    </tr>
                </thead>
                <tbody id="stock-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- ç»“æœå¡ç‰‡ -->
<div class="card open" id="card-result">
    <div class="card-header" onclick="toggleCard('card-result')">
        <div class="header-title"><span>ğŸ“Š é«˜è‚¡æ¯å›æµ‹</span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body">
        <div class="run-bar">
            <div class="form-group"><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="inStartDate"></div>
            <div class="form-group"><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="inEndDate"></div>
            <button class="btn btn-blue" id="btn-run-all" onclick="runBatchBacktest()">ğŸš€ å¼€å§‹å›æµ‹</button>
        </div>

        <div class="toggle-link" onclick="toggleAdvSettings()">ğŸ›  ç­–ç•¥å‚æ•°è®¾ç½® â–¼</div>

        <div id="adv-settings">
            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ¯ ç›®æ ‡è‚¡æ¯ç‡é˜ˆå€¼ (%)</label>
                    <input type="number" id="pYieldThreshold" step="0.1" value="5.0">
                    <div style="font-size:10px;color:#999">é«˜äºæ­¤å€¼ä¹°å…¥ï¼Œä½äºæ­¤å€¼å–å‡º</div>
                </div>
                <div class="form-group">
                    <label>ğŸ”„ è°ƒä»“é¢‘ç‡</label>
                    <select id="pRebalanceFreq">
                        <option value="1">æ¯æ—¥æ£€æŸ¥ (Daily)</option>
                        <option value="5">æ¯å‘¨æ£€æŸ¥ (Weekly)</option>
                        <option value="20" selected>æ¯æœˆæ£€æŸ¥ (Monthly)</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>ä¹°å…¥ä»“ä½ (0-1)</label><input type="number" id="pPosSize" step="0.1" value="1.0"></div>
            </div>
        </div>

        <div id="batch-progress" style="display:none; margin:12px 0; padding:10px; background:#e3f2fd; color:#0056b3; font-size:13px; border-radius:4px; text-align:center;"></div>

        <!-- ç»“æœç»Ÿä¸€å±•ç¤ºå®¹å™¨ -->
        <div id="results-container" style="display:none; margin-top:15px;">
            <!-- 1. æ”¶ç›Šæ’è¡Œæ¦œ -->
            <div id="batch-summary-box" style="margin-bottom:15px;">
                <div class="section-header expanded" onclick="toggleSection('summary-content', this)">
                    <span>ğŸ“ˆ ä¸ªè‚¡è¡¨ç°</span> <span class="arrow header-arrow">â–¼</span>
                </div>
                <div id="summary-content" class="section-body">
                    <div class="summary-wrapper">
                        <table class="summary-table">
                            <thead><tr><th>è‚¡ç¥¨</th><th>å¹³å‡è‚¡æ¯ç‡</th><th>ç­–ç•¥æ”¶ç›Š</th><th>æŒä»“å¤©æ•°</th></tr></thead>
                            <tbody id="summary-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2. ç»„åˆç­–ç•¥ -->
            <div id="portfolio-section" style="margin-bottom:15px;">
                <div class="section-header expanded" onclick="toggleSection('portfolio-content', this)">
                    <span>ğŸ’° é«˜è‚¡æ¯ç»„åˆ (Portfolio)</span> <span class="arrow header-arrow">â–¼</span>
                </div>
                <div id="portfolio-content" class="section-body">
                    <div style="text-align:right; margin-bottom:10px;">
                        <button class="btn btn-orange" onclick="runPortfolioStrategy()" style="width:100%">ğŸ”„ é‡æ–°è®¡ç®—ç»„åˆ</button>
                    </div>
                    <div class="stat-grid">
                        <div class="stat-item"><div class="stat-val" id="port-ret">--</div><div class="stat-lbl">ç»„åˆæ€»æ”¶ç›Š</div></div>
                        <div class="stat-item"><div class="stat-val" id="port-dd">--</div><div class="stat-lbl">æœ€å¤§å›æ’¤</div></div>
                        <div class="stat-item"><div class="stat-val" id="port-yield">--</div><div class="stat-lbl">å¹³å‡ç»„åˆè‚¡æ¯ç‡</div></div>
                    </div>
                    <div id="portfolio-chart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>
        </div> 
        
        <!-- å•åªè¯¦æƒ… -->
        <div id="detail-view" style="display:none; border-top: 2px dashed #eee; margin-top: 20px; padding-top: 15px;">
            <h4 style="margin:0 0 10px 0;" id="detail-title">è¯¦ç»†ä¿¡æ¯</h4>
            <div id="chart-box" style="width: 100%; height: 400px;"></div>
            <div style="margin-top:20px;">
                <div class="section-header" onclick="toggleSection('log-content', this)">
                    <span>ğŸ“œ äº¤æ˜“ä¸è‚¡æ¯ç‡æ—¥å¿—</span> <span class="arrow header-arrow">â–¼</span>
                </div>
                <div id="log-content" class="section-body collapsed" style="border:1px solid #eee; border-radius:6px; border-top:0;">
                    <div style="max-height: 300px; overflow: auto;">
                        <table class="log-table">
                            <thead style="background:#f9f9f9;">
                                <tr><th>æ—¥æœŸ</th><th>åŠ¨ä½œ</th><th>è‚¡æ¯ç‡</th><th>è¯´æ˜</th></tr>
                            </thead>
                            <tbody id="log-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
</div>

<!-- Token Modal -->
<div id="token-modal" class="modal">
    <div class="modal-box">
        <h3>ğŸ”‘ GitHub Token</h3>
        <p style="font-size:12px;color:#666;margin-bottom:10px;">é¦–æ¬¡ä½¿ç”¨éœ€è¦è¾“å…¥ Token ä»¥ä¿å­˜é…ç½®åˆ° GitHubã€‚</p>
        <input type="text" id="gh-token-input" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:15px;" placeholder="ghp_xxxx...">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-gray" style="flex:1" onclick="document.getElementById('token-modal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-blue" style="flex:1" onclick="saveToken()">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
    // === é…ç½®ä¸å·¥å…· ===
    // è¯·ä¿®æ”¹è¿™é‡Œçš„ repo ä¿¡æ¯ä¸ºä½ è‡ªå·±çš„
    const GITHUB_CONFIG = { username: "dlezywj-cell", repo: "backtest", path: "dividend_config.json", branch: "main" };
    const PROXY = 'https://corsproxy.io/?'; 
    
    // æ•°æ®ç»“æ„ï¼š{ code: "600519.SH", name: "èŒ…å°", dividend: 70000000000, lastMod: "2023-12-01" }
    let stocks = JSON.parse(localStorage.getItem('divStocks')) || [];
    
    let myChart = null;
    let portfolioChart = null;
    let batchResults = [];

    // === æ—¥æœŸåˆå§‹åŒ– ===
    function initDates() {
        const d = new Date();
        document.getElementById('inEndDate').value = d.toISOString().split('T')[0];
        d.setFullYear(d.getFullYear() - 1); // é»˜è®¤å›æµ‹ä¸€å¹´
        document.getElementById('inStartDate').value = d.toISOString().split('T')[0];
    }
    initDates();
    renderTable();
    checkUnsavedStatus();

    // === UI äº¤äº’ ===
    function checkUnsavedStatus() {
        const dirty = localStorage.getItem('divHasUnsavedChanges') === 'true';
        const btn = document.getElementById('btn-push');
        if (dirty) {
            btn.classList.add('unsaved');
            btn.innerHTML = "ğŸ”´ å¾…åŒæ­¥é…ç½®";
        } else {
            btn.classList.remove('unsaved');
            btn.innerHTML = "ğŸš€ 2. ä¿å­˜é…ç½®åˆ° GitHub";
        }
    }
    function setLocalChanges(isDirty) {
        localStorage.setItem('divHasUnsavedChanges', isDirty);
        checkUnsavedStatus();
    }
    function toggleCard(id) { 
        const el = document.getElementById(id); el.classList.toggle('open'); 
        if(el.classList.contains('open') && (myChart || portfolioChart)) { setTimeout(() => { if(myChart) myChart.resize(); if(portfolioChart) portfolioChart.resize(); }, 200); }
    }
    function toggleSection(contentId, headerEl) {
        const content = document.getElementById(contentId);
        content.classList.toggle('collapsed');
        headerEl.classList.toggle('expanded');
    }
    function toggleAdvSettings() {
        const el = document.getElementById('adv-settings');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    // === Excel å¯¼å…¥é€»è¾‘ (æ™ºèƒ½ä¸¥æ ¼ç‰ˆ) ===
    function importFromExcel(input) {
        const file = input.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1}); 

                if(jsonData.length < 2) throw new Error("Excel æ•°æ®å¤ªå°‘");
                
                // 1. è¯†åˆ«åˆ—å
                const headers = jsonData[0].map(h => String(h).trim());
                const codeIdx = headers.findIndex(h => /ä»£ç |Code/i.test(h));
                const nameIdx = headers.findIndex(h => /åç§°|Name/i.test(h));
                
                // === å…³é”®ä¿®æ”¹ï¼šä¸¥æ ¼åŒ¹é…åˆ†çº¢åˆ—å ===
                let divIdx = -1;
                
                // ä¼˜å…ˆçº§ 1: ç²¾ç¡®ç­‰äºâ€œåˆ†çº¢â€
                divIdx = headers.indexOf('åˆ†çº¢'); 
                
                // ä¼˜å…ˆçº§ 2: å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•â€œåˆ†çº¢æ€»é¢â€æˆ–â€œç°é‡‘åˆ†çº¢â€ç­‰æ˜ç¡®è¡¨ç¤ºæ€»é¢çš„è¯
                if (divIdx === -1) {
                    const explicitTargets = ['åˆ†çº¢æ€»é¢', 'ç°é‡‘åˆ†çº¢', 'ç°é‡‘åˆ†çº¢æ€»é¢', 'Dividend', 'Total Dividend'];
                    divIdx = headers.findIndex(h => explicitTargets.includes(h));
                }

                // ä¼˜å…ˆçº§ 3: æ¨¡ç³ŠåŒ¹é…ï¼Œä½†å¼ºåˆ¶ã€æ’é™¤ã€‘â€œæ¯è‚¡â€ (Per Share)
                // åªæœ‰å½“æ‰¾ä¸åˆ°ç²¾ç¡®åˆ—æ—¶æ‰ç”¨è¿™ä¸ªï¼Œé¿å…æŠŠ "æ¯è‚¡åˆ†çº¢" è¯¯è®¤ä¸º "åˆ†çº¢"
                if (divIdx === -1) {
                    divIdx = headers.findIndex(h => {
                        const text = h.toUpperCase();
                        // åŒ…å«åˆ†çº¢/Dividend/æ´¾æ¯ï¼Œä½†ç»ä¸åŒ…å«æ¯è‚¡/EPS/Per Share
                        return (/åˆ†çº¢|DIVIDEND|æ´¾æ¯/.test(text) && !/æ¯è‚¡|EPS|PER SHARE/.test(text));
                    });
                }

                if(codeIdx === -1 || divIdx === -1) {
                    alert("âŒ æ— æ³•è¯†åˆ«ã€ä»£ç ã€‘æˆ–ã€åˆ†çº¢ã€‘åˆ—ã€‚\n\nè¯·ç¡®ä¿ExcelåŒ…å«åˆ—åâ€œåˆ†çº¢â€ï¼ˆå³å¹´åº¦åˆ†çº¢æ€»é¢ï¼‰ã€‚");
                    return;
                }

                let newStocks = [];
                let today = new Date().toISOString().split('T')[0];
                let smallValueCount = 0; 

                for(let i=1; i<jsonData.length; i++) {
                    const row = jsonData[i];
                    if(!row[codeIdx]) continue; 

                    let rawCode = String(row[codeIdx]).trim();
                    let suffix = "";
                    if (/^\d{5}$/.test(rawCode)) suffix = ".HK"; 
                    else if (/^\d{6}$/.test(rawCode)) suffix = rawCode.startsWith('6') ? ".SH" : ".SZ";
                    if(!rawCode.includes('.')) rawCode += suffix;

                    // åˆ†çº¢å¤„ç†
                    let rawDiv = row[divIdx];
                    let divVal = 0;
                    if (rawDiv) {
                        let strVal = String(rawDiv).replace(/,/g, '');
                        let multiplier = 1;
                        if (strVal.includes('äº¿')) { multiplier = 100000000; strVal = strVal.replace('äº¿', ''); } 
                        else if (strVal.includes('ä¸‡')) { multiplier = 10000; strVal = strVal.replace('ä¸‡', ''); }
                        divVal = parseFloat(strVal);
                        if (!isNaN(divVal)) divVal = divVal * multiplier; else divVal = 0;
                    }

                    if(divVal > 0 && divVal < 1000000) smallValueCount++;

                    newStocks.push({
                        code: rawCode,
                        name: (nameIdx !== -1 && row[nameIdx]) ? row[nameIdx] : rawCode,
                        dividend: divVal,
                        lastMod: today
                    });
                }

                // å¦‚æœä¾ç„¶æ£€æµ‹åˆ°å¤§é‡å°æ•°å€¼ï¼ˆå¯èƒ½æ˜¯å› ä¸ºå•ä½æ˜¯äº¿ä½†æ²¡å†™äº¿å­—ï¼‰ï¼Œæç¤ºç”¨æˆ·
                if(smallValueCount > newStocks.length * 0.5) {
                    let fix = confirm(`âš ï¸ è­¦å‘Šï¼šç³»ç»Ÿè¯»å–åˆ°â€œåˆ†çº¢â€åˆ—æ•°æ®è¾ƒå°ï¼ˆå¦‚ 50ï¼‰ã€‚\n\nç³»ç»Ÿéœ€è¦å•ä½ä¸ºã€å…ƒã€‘ã€‚\nâ— å¦‚æœè¡¨æ ¼å•ä½æ˜¯ã€äº¿å…ƒã€‘(50ä»£è¡¨50äº¿)ï¼Œè¯·ç‚¹ã€ç¡®å®šã€‘ã€‚\nâ— å¦‚æœè¡¨æ ¼å•ä½ç¡®å®æ˜¯å…ƒï¼Œè¯·ç‚¹ã€å–æ¶ˆã€‘ã€‚`);
                    if(fix) newStocks.forEach(s => s.dividend = s.dividend * 100000000);
                }

                if(confirm(`è§£ææˆåŠŸï¼å…±æ‰¾åˆ° ${newStocks.length} æ¡æ•°æ®ã€‚\næ˜¯å¦è¦†ç›–å½“å‰åˆ—è¡¨ï¼Ÿ`)) {
                    stocks = newStocks;
                    localStorage.setItem('divStocks', JSON.stringify(stocks));
                    renderTable();
                    setLocalChanges(true);
                    alert("âœ… å¯¼å…¥æˆåŠŸï¼");
                }
            } catch(err) {
                console.error(err);
                alert("âŒ è¯»å– Excel å¤±è´¥: " + err.message);
            }
            input.value = ''; 
        };
        reader.readAsArrayBuffer(file);
    }

    // === æ•°æ®æ“ä½œ ===
    function renderTable() {
        const tb = document.getElementById('stock-tbody'); 
        tb.innerHTML = stocks.map((s, i) => {
            let divStr = (s.dividend / 100000000).toFixed(2) + "äº¿";
            return `
            <tr>
                <td><b>${s.name}</b> <span style="color:#999;font-size:12px">${s.code}</span></td>
                <td>${divStr}</td>
                <td style="text-align:center;"><div class="op-btn-group" style="display:flex;justify-content:center;gap:5px;">
                    <button class="btn btn-edit-yellow btn-icon-square" onclick="editStock(${i})">âœ</button>
                    <button class="btn btn-del-red btn-icon-square" onclick="delStock(${i})">âœ•</button>
                </div></td>
                <td style="text-align:center;"><input type="checkbox" class="stock-chk" value="${i}" checked></td>
            </tr>
        `}).join('');
        document.getElementById('list-count').innerText = `(${stocks.length})`;
        checkAllState();
    }

    // ç¼–è¾‘ï¼šå¡«å……åˆ°ä¸Šæ–¹è¾“å…¥æ¡†
    function editStock(i) {
        const s = stocks[i];
        if(!s) return;
        document.getElementById('inName').value = s.name;
        document.getElementById('inCode').value = s.code;
        document.getElementById('inDividend').value = s.dividend;
        
        // UIåé¦ˆ
        const btn = document.getElementById('btn-save-single');
        const originalText = btn.innerText;
        btn.innerText = "âœï¸ å‡†å¤‡ä¿å­˜ä¿®æ”¹...";
        setTimeout(() => btn.innerText = originalText, 1500);
        
        document.getElementById('card-config').scrollIntoView({behavior: 'smooth'});
        document.getElementById('inDividend').focus();
    }

    // ä¿å­˜å•æ¡ï¼ˆæ–°å¢æˆ–ä¿®æ”¹ï¼‰
    function saveStock() {
        const code = document.getElementById('inCode').value.trim(); 
        const name = document.getElementById('inName').value.trim(); 
        const div = parseFloat(document.getElementById('inDividend').value);
        if(!code || isNaN(div)) return alert("è¯·å¡«å†™å®Œæ•´ï¼šä»£ç ã€åç§°ã€åˆ†çº¢é‡‘é¢");
        
        const today = new Date().toISOString().split('T')[0];
        const item = { code, name, dividend: div, lastMod: today }; 
        
        const idx = stocks.findIndex(s => s.code === code);
        if(idx >= 0) {
            stocks[idx] = item; // æ›´æ–°
            alert(`å·²æ›´æ–°ï¼š${name}`);
        } else {
            stocks.push(item); // æ–°å¢
            alert(`å·²æ·»åŠ ï¼š${name}`);
        }
        
        localStorage.setItem('divStocks', JSON.stringify(stocks)); 
        renderTable(); 
        setLocalChanges(true);
        
        // æ¸…ç©ºè¾“å…¥æ¡†æ–¹ä¾¿ä¸‹ä¸€æ¬¡
        document.getElementById('inCode').value = '';
        document.getElementById('inName').value = '';
        document.getElementById('inDividend').value = '';
    }

    function delStock(i) {
        if(confirm("åˆ é™¤æ­¤æ¡?")) {
            stocks.splice(i, 1);
            localStorage.setItem('divStocks', JSON.stringify(stocks));
            renderTable();
            setLocalChanges(true);
        }
    }
    
    function toggleAllStocks(el) { document.querySelectorAll('.stock-chk').forEach(chk => chk.checked = el.checked); }
    function checkAllState() { const all = document.querySelectorAll('.stock-chk'); const checked = document.querySelectorAll('.stock-chk:checked'); document.getElementById('check-all').checked = (all.length > 0 && all.length === checked.length); }
    document.addEventListener('change', function(e){ if(e.target.classList.contains('stock-chk')) checkAllState(); });

    // === GitHub åŒæ­¥ ===
    function safeB64ToUtf8(str) { return decodeURIComponent(escape(window.atob(str.replace(/\s/g, '')))); }
    function utf8ToB64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
    
    async function uploadToGithub() {
        let token = localStorage.getItem("github_token");
        if (!token) { document.getElementById('token-modal').style.display='flex'; return; }
        const btn = document.getElementById('btn-push'); const origin = btn.innerText; btn.innerText = "â³"; btn.disabled = true;
        try {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
            const get = await fetch(url, { headers: { "Authorization": `token ${token.trim()}` } });
            let sha = null; if (get.ok) sha = (await get.json()).sha;
            await fetch(url, { method: "PUT", headers: { "Authorization": `token ${token.trim()}` }, body: JSON.stringify({ message: "Update dividend config", content: utf8ToB64(JSON.stringify(stocks, null, 2)), sha }) });
            alert("âœ… åŒæ­¥æˆåŠŸ!");
            setLocalChanges(false);
        } catch (e) { alert("âŒ " + e.message); if(e.message.includes("401")) localStorage.removeItem("github_token"); } 
        finally { btn.innerText = origin; btn.disabled = false; checkUnsavedStatus(); }
    }
    
    async function syncFromGithub() {
        let token = localStorage.getItem("github_token");
        const btn = document.getElementById('btn-pull'); const origin = btn.innerText; btn.innerText = "â³"; btn.disabled = true;
        try {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
            const h = { "Accept": "application/vnd.github.v3+json" };
            if(token) h["Authorization"] = `token ${token.trim()}`;
            let res = await fetch(url, { headers: h });
            let data;
            if (res.ok) { data = JSON.parse(safeB64ToUtf8((await res.json()).content)); } 
            else { 
                const raw = await fetch(`https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}?t=${Date.now()}`); 
                if(!raw.ok) throw new Error("äº‘ç«¯æ— æ•°æ®"); data = await raw.json(); 
            }
            if(Array.isArray(data) && confirm(`äº‘ç«¯æœ‰ ${data.length} æ¡æ•°æ®ï¼Œè¦†ç›–æœ¬åœ°ï¼Ÿ`)) { 
                stocks = data; 
                localStorage.setItem('divStocks', JSON.stringify(stocks)); 
                renderTable(); 
                setLocalChanges(false); 
            }
        } catch (e) { alert("âŒ " + e.message); } finally { btn.innerText = origin; btn.disabled = false; }
    }
    function saveToken() { const t = document.getElementById('gh-token-input').value.trim(); if(t) { localStorage.setItem('github_token', t); document.getElementById('token-modal').style.display='none'; uploadToGithub(); } }

    // === æ ¸å¿ƒå›æµ‹é€»è¾‘ï¼šé«˜è‚¡æ¯ç®—æ³• ===
    const getEmSecId = c => { let raw = c.replace(/\.[A-Z]+$/, ''); if (c.includes('.HK') || /^\d{5}$/.test(raw)) return '116.' + raw.padStart(5, '0'); if (raw.startsWith('6')) return '1.' + raw; return '0.' + raw; };
    
    async function fetchEmKline(secId) {
        const url = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${secId}&fields1=f1&fields2=f51,f53&klt=101&fqt=1&end=20500101&lmt=500`;
        const res = await fetch(PROXY + encodeURIComponent(url));
        const json = await res.json();
        return json?.data?.klines || [];
    }

    async function calculateStock(stock) {
        const yieldThreshold = parseFloat(document.getElementById('pYieldThreshold').value) || 5.0; // %
        const targetPos = parseFloat(document.getElementById('pPosSize').value) || 1.0;
        const rebalanceFreq = parseInt(document.getElementById('pRebalanceFreq').value) || 20; // Days
        
        let emSecId = getEmSecId(stock.code); 
        let emCode = emSecId.split('.')[1];

        const snapUrl = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${emSecId}&fields=f2,f20&invt=2&fltt=2`;
        const snapRes = await fetch(PROXY + encodeURIComponent(snapUrl));
        const snapJson = await snapRes.json();
        
        let totalShares = 0;
        if (snapJson.data?.diff) {
            let d = Array.isArray(snapJson.data.diff) ? snapJson.data.diff[0] : snapJson.data.diff[emCode];
            if(d && d.f2 > 0) totalShares = d.f20 / d.f2;
        }
        
        if(!totalShares) throw new Error(`æ— æ³•è·å–è‚¡æœ¬æ•°æ® (APIé™åˆ¶æˆ–é€€å¸‚)`);

        const klines = await fetchEmKline(emSecId);
        if(!klines || klines.length === 0) throw new Error("æ— Kçº¿æ•°æ®");

        const userStartDate = document.getElementById('inStartDate').value;
        const userEndDate = document.getElementById('inEndDate').value;
        const totalDiv = stock.dividend; 

        let history = []; 
        let logs = [];
        let nav = 1.0; 
        let hold = 0; 
        let daysHeld = 0;
        let sumYield = 0; 
        let yieldCount = 0;

        let filteredKlines = [];
        klines.forEach(k => {
            const parts = k.split(',');
            if (parts[0] >= userStartDate && parts[0] <= userEndDate) {
                filteredKlines.push({ date: parts[0], close: parseFloat(parts[1]) });
            }
        });
        
        if(filteredKlines.length === 0) throw new Error("æ—¥æœŸèŒƒå›´å†…æ— æ•°æ®");

        history.push({ 
            date: filteredKlines[0].date, 
            nav: 1.0, 
            close: filteredKlines[0].close, 
            pos: 0, 
            dy: (totalDiv / (filteredKlines[0].close * totalShares)) * 100 
        });

        for(let i=1; i<filteredKlines.length; i++) {
            const d = filteredKlines[i];
            const prevD = filteredKlines[i-1];
            
            const marketCap = d.close * totalShares;
            const currentYield = (totalDiv / marketCap) * 100; // %
            
            sumYield += currentYield; yieldCount++;

            let action = null;
            let reason = "";

            if (i % rebalanceFreq === 0) {
                if (currentYield > yieldThreshold) {
                    if (hold === 0) {
                        hold = targetPos;
                        action = `<span class="badge bg-red">ä¹°å…¥</span>`;
                        reason = `è‚¡æ¯ç‡ ${currentYield.toFixed(2)}% > ${yieldThreshold}%`;
                    }
                } else {
                    if (hold > 0) {
                        hold = 0;
                        action = `<span class="badge bg-green">å–å‡º</span>`;
                        reason = `è‚¡æ¯ç‡ ${currentYield.toFixed(2)}% < ${yieldThreshold}%`;
                    }
                }
            }
            
            const r = (d.close / prevD.close) - 1;
            nav = nav * (1 + hold * r);
            if(hold > 0) daysHeld++;

            if(action) {
                logs.push({ date: d.date, action: action, dy: currentYield.toFixed(2)+'%', reason: reason });
            }

            history.push({ date: d.date, nav: nav, close: d.close, pos: hold, dy: currentYield });
        }

        const stats = {
            ret: (history[history.length-1].nav - 1) * 100,
            avgYield: yieldCount > 0 ? (sumYield / yieldCount) : 0,
            daysHeld: daysHeld
        };

        return { 
            stockName: stock.name, 
            stockCode: stock.code, 
            history: history, 
            logs: logs, 
            stats: stats 
        };
    }

    // === è¿è¡Œæ§åˆ¶ ===
    async function runBatchBacktest() {
        const checkedBoxes = document.querySelectorAll('.stock-chk:checked');
        if(checkedBoxes.length === 0) return alert("è¯·è‡³å°‘å‹¾é€‰ä¸€åªè‚¡ç¥¨");
        
        const selectedIndices = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
        const btn = document.getElementById('btn-run-all');
        const progress = document.getElementById('batch-progress');
        
        btn.innerText = "â³ è®¡ç®—ä¸­..."; btn.disabled = true;
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('summary-tbody').innerHTML = '';
        progress.style.display = 'block';
        
        batchResults = []; 
        let successCount = 0;

        for(let step=0; step < selectedIndices.length; step++) {
            const i = selectedIndices[step]; const s = stocks[i];
            progress.innerHTML = `æ­£åœ¨è®¡ç®— <b>${s.name}</b> (${step+1}/${selectedIndices.length})...`;
            try {
                const res = await calculateStock(s); 
                res.index = i; 
                batchResults.push(res); 
                
                const tr = document.createElement('tr');
                tr.onclick = () => showDetail(i);
                const cRet = res.stats.ret >= 0 ? 'val-pos' : 'val-neg';
                tr.innerHTML = `<td><b>${res.stockName}</b></td><td>${res.stats.avgYield.toFixed(2)}%</td><td class="${cRet}">${res.stats.ret.toFixed(1)}%</td><td>${res.stats.daysHeld}å¤©</td>`;
                document.getElementById('summary-tbody').appendChild(tr);
                
                successCount++;
            } catch(e) { console.error(s.name, e); }
            await new Promise(r => setTimeout(r, 50));
        }
        
        progress.innerHTML = `âœ… å®Œæˆ! æˆåŠŸ ${successCount} åª`;
        btn.innerText = "ğŸš€ å¼€å§‹å›æµ‹"; btn.disabled = false;
        
        if(batchResults.length > 0) {
            document.getElementById('results-container').style.display = 'block';
            runPortfolioStrategy();
            showDetail(batchResults[0].index); 
        }
    }

    function showDetail(index) {
        const res = batchResults.find(r => r.index === index); 
        if(!res) return;
        
        document.getElementById('detail-view').style.display = 'block';
        document.getElementById('detail-title').innerText = `${res.stockName} (${res.stockCode})`;
        document.querySelectorAll('.summary-table tr').forEach(r => r.classList.remove('selected'));
        
        const dom = document.getElementById('chart-box'); 
        if(myChart) myChart.dispose(); 
        myChart = echarts.init(dom);
        
        const dates = res.history.map(h => h.date);
        myChart.setOption({
            tooltip: { trigger: 'axis', axisPointer: {type:'cross'} },
            legend: { data: ['å‡€å€¼','è‚¡ä»·','è‚¡æ¯ç‡(å³)','ä»“ä½'], top:0 },
            grid: [{left:'10%',right:'10%',top:'10%',height:'60%'}, {left:'10%',right:'10%',top:'75%',height:'15%'}],
            xAxis: [{data:dates, gridIndex:0}, {data:dates, gridIndex:1, show:false}],
            yAxis: [
                {name:'å‡€å€¼/è‚¡ä»·', position:'left'}, 
                {name:'è‚¡æ¯ç‡%', position:'right', splitLine:{show:false}},
                {gridIndex:1, max:1.2, splitLine:{show:false}, axisLabel:{show:false}}
            ],
            series: [
                {name:'å‡€å€¼', type:'line', data:res.history.map(h=>h.nav), itemStyle:{color:'#d32f2f'}, lineStyle:{width:2}},
                {name:'è‚¡ä»·', type:'line', data:res.history.map(h=>h.close), itemStyle:{color:'#ccc'}, lineStyle:{width:1}},
                {name:'è‚¡æ¯ç‡(å³)', type:'line', yAxisIndex:1, data:res.history.map(h=>h.dy), itemStyle:{color:'#fd7e14'}, lineStyle:{width:1, type:'dashed'}},
                {name:'ä»“ä½', type:'area', xAxisIndex:1, yAxisIndex:2, data:res.history.map(h=>h.pos), itemStyle:{color:'#28a745', opacity:0.3}, step:'end'}
            ]
        });

        const logBody = document.getElementById('log-tbody');
        logBody.innerHTML = res.logs.map(l => `
            <tr>
                <td>${l.date}</td>
                <td style="text-align:center">${l.action}</td>
                <td style="text-align:center">${l.dy}</td>
                <td style="color:#666;font-size:11px;">${l.reason}</td>
            </tr>
        `).join('');
    }

    function runPortfolioStrategy() {
        if(!batchResults.length) return;
        let dateMap = {};
        batchResults.forEach(res => {
            res.history.forEach(h => {
                if(!dateMap[h.date]) dateMap[h.date] = { count:0, sumRet:0, sumYield:0, stocks:0 };
            });
        });
        
        let dates = Object.keys(dateMap).sort();
        let portNav = 1.0;
        let portHist = [];
        let maxDD = 0, peak = 1.0;

        for(let i=1; i<dates.length; i++) {
            let today = dates[i];
            let prevDay = dates[i-1];
            let dailySumRet = 0;
            let activeCount = 0;
            let currentYieldSum = 0;
            let currentYieldCount = 0;

            batchResults.forEach(res => {
                const dNow = res.history.find(h => h.date === today);
                const dPrev = res.history.find(h => h.date === prevDay);
                if(dNow && dPrev) {
                    if(dPrev.pos > 0) {
                        const r = (dNow.close / dPrev.close) - 1;
                        dailySumRet += r;
                        activeCount++;
                    }
                    if(dNow.dy) {
                        currentYieldSum += dNow.dy;
                        currentYieldCount++;
                    }
                }
            });

            let avgRet = activeCount > 0 ? (dailySumRet / activeCount) : 0;
            portNav = portNav * (1 + avgRet);
            if(portNav > peak) peak = portNav;
            let dd = (peak - portNav) / peak; if(dd > maxDD) maxDD = dd;
            
            portHist.push({
                date: today,
                nav: portNav,
                avgYield: currentYieldCount > 0 ? (currentYieldSum / currentYieldCount) : 0
            });
        }
        
        const pLast = portHist[portHist.length-1];
        if(!pLast) return;

        document.getElementById('port-ret').innerText = ((pLast.nav - 1)*100).toFixed(2) + "%";
        document.getElementById('port-ret').className = pLast.nav >= 1 ? 'stat-val win' : 'stat-val loss';
        document.getElementById('port-dd').innerText = (maxDD * 100).toFixed(2) + "%";
        document.getElementById('port-yield').innerText = pLast.avgYield.toFixed(2) + "%";

        const dom = document.getElementById('portfolio-chart');
        if(portfolioChart) portfolioChart.dispose();
        portfolioChart = echarts.init(dom);
        
        portfolioChart.setOption({
            tooltip: { trigger: 'axis' },
            legend: { data: ['ç»„åˆå‡€å€¼','å¹³å‡è‚¡æ¯ç‡(å³)'] },
            xAxis: { data: portHist.map(h=>h.date) },
            yAxis: [{name:'å‡€å€¼'}, {name:'è‚¡æ¯ç‡%', position:'right', splitLine:{show:false}}],
            series: [
                {name:'ç»„åˆå‡€å€¼', type:'line', data:portHist.map(h=>h.nav), itemStyle:{color:'#d32f2f'}, areaStyle:{opacity:0.1}},
                {name:'å¹³å‡è‚¡æ¯ç‡(å³)', type:'line', yAxisIndex:1, data:portHist.map(h=>h.avgYield), itemStyle:{color:'#1976d2'}, lineStyle:{width:1, type:'dashed'}}
            ]
        });
    }
</script>
</body>
</html>
